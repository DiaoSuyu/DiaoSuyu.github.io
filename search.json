[{"title":"[Git] A useful guide of Git","url":"/2024/07/19/Git/Git/","content":"\nThis document collects practical Git commands and workflows that are frequently useful when maintaining repositories, migrating history, or cleaning large objects.\n\n1. Merge a local repository into a Gerrit repositoryThis section describes a safe flow for merging a local repository (with multiple commits) into a Gerrit repository.\n\nChange to the Gerrit repository directory:\ncd /d/Project/SAM_TEST\n\nView the commit history of the current branch:\ngit log\n\nExample output:\n  commit 50eec5571740b778fdc1310b596bb1f88b27ba11 (HEAD -&gt; MCU, origin/MCU)Author: diaosuyu &lt;diaosuyu@sk1999.com&gt;Date:   Fri Jul 19 16:13:10 2024 +0800    Initial MCU repository    Change-Id: Ief4a48e643427282357be4c6a6a54ee731294812commit b077e2c70c45947a329637a12f9c9f3ced1aecdb (origin/master, origin/HEAD, master)Author: sunkaiwei &lt;sunkaiwei@sk1999.com&gt;Date:   Wed Jul 3 14:44:36 2024 +0800    Initial empty repository\n\n\nCreate and switch to a temporary branch that points to a specific commit (replace the commit SHA as needed):\ngit checkout -b temp-branch 50eec5571740b778fdc1310b596bb1f88b27ba11\n\nExample output:\n  Switched to a new branch &#x27;temp-branch&#x27;\n\n\nAdd the &#x2F;d&#x2F;Project&#x2F;MCU_I2C_Driver&#x2F;CRB directory as a remote repository of &#x2F;d&#x2F;Project&#x2F;SAM_TEST called temp-repo\ngit remote add temp-repo /d/Project/MCU_I2C_Driver/CRBgit fetch temp-repo\n\nExample fetch output:\n  remote: Enumerating objects: 46795, done.remote: Counting objects: 100% (46795/46795), done.remote: Compressing objects: 100% (30625/30625), done.remote: Total 46795 (delta 15879), reused 43891 (delta 14840), pack-reused 0Receiving objects: 100% (46795/46795), 3.74 GiB | 3.84 MiB/s, done.Resolving deltas: 100% (15879/15879), done.From D:/Project/MCU_I2C_Driver/CRB * [new branch]      master      -&gt; temp-repo/master * [new branch]      temp_branch -&gt; temp-repo/temp_branch\n\n\nMerge the fetched branch into your temporary branch (allow unrelated histories if necessary):\ngit merge temp-repo/master --allow-unrelated-histories\n\nCheck the working tree and commit history, then push for review to Gerrit:\ngit status\n\nDisplays the commit history of the current branch, including author, date, and commit information\ngit log\n\nPush the temp-branch branch to the master branch of the remote repository origin\ngit push origin temp-branch:refs/for/master\n\nFinally, delete the temporary branch locally when finished:\ngit branch -d temp-branch\n\n2. Check commits for missing Change-IdIf your Gerrit workflow requires a Change-Id footer, use the script below to scan all commits and report which ones are missing it.\n\nSave the script as check_change_id.sh in the repository root and make it executable.\n#!/bin/bash# Iterate over each commit and check for Change-Id in the commit messagegit log --format=&quot;%H&quot; | while read commit_hash; do    commit_message=$(git log -1 --format=%B &quot;$commit_hash&quot;)    if echo &quot;$commit_message&quot; | grep -q &quot;Change-Id:&quot;; then        echo &quot;$commit_hash: Change-Id found&quot;    else        echo &quot;$commit_hash: Missing Change-Id&quot;    fidone\n\nMake executable and run:\nchmod +x check_change_id.sh./check_change_id.sh\n\nExecute check_change_id.sh, example output (truncated):\n./check_change_id.sh↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓1194b52298e7bda60cef2ec214de0f453d52fee1: Change-Id found11da9fea22d07d32555ef72e3be616dc4b60c4b2: Change-Id foundc92aa62a800ca64e2335a0443571ae25fe74f348: Change-Id found30d7c4ba9d88d1176431d540d82150e388640e5c: Change-Id found0fd82225a1c1ecafd4bccdb4b706d16a01d326e0: Change-Id found75557aeeeaa272fed582d6154f214a1bcd1bf2a5: Missing Change-Id0d649df8473c89a1ffb00e71ed4dea54bedfc3ed: Change-Id foundacaea09e73dfb99e058f5f6653e8128cca9ea860: Change-Id found0489bdd005eb05efd76d73538204c70e7fcc9f7a: Change-Id found037e43ec75b9b8258a81469ef080989b4c7e0bab: Change-Id foundca9c38e9ac3938783ebaf8a368815e0b80dfab88: Change-Id found0d139abb70c6f4057a84dc42c3dae6174d4d467d: Change-Id found8096abedf0749786fd1f77a4ddf8169b3f224525: Change-Id found5fdfdb378bf3e250b53bef811d629e12ccc32990: Change-Id founde414a5bbc8700428f58c043e280e2af7452d997e: Change-Id found16708024185cc2785b757bd14c4bbc3af928dd3e: Change-Id found9aef401122d031269fd7773c3b6c477bf12134f5: Change-Id foundcdc2680732fb3f85e69a10b80a242fffed8e592a: Change-Id foundb2daf1f0bce17420bb4eba1071ed9d997e0de50a: Change-Id foundbeedc2a23335de45b95ef550471b014a971e82e2: Change-Id found76d0b82220d1c623519b728e7bf2bcc82f521f95: Change-Id found1ff01138cec6c72f7415309ce7f5a68c4d9267b9: Change-Id found21de2e5bcbb64abce065930e2e4bd5bc80ac8448: Change-Id found5086c66cabc82960f88f80272ad07f8cedafa0d0: Change-Id found705eb6452c130a0685f96d83fef96479cc307497: Change-Id foundb29f9aaa1280e9063318be079f61daa9a420930f: Change-Id foundb28b16e765c40a4c7c4480be8aa6fc15f31303b1: Change-Id found9e5bf10c39a2655a0aa4dead56a91be785f34e9c: Missing Change-Id1e1ec902ba5db0c3cecb916099d78f8f163aafc1: Change-Id found18088669a6ea387f59379d2179eeb12eaedc1466: Change-Id found9fa1eca911c89547e47164ea9860fbfedac3c72d: Change-Id found061dd547c4a2281dbb7c1512fa799ac7521e41c1: Change-Id founda0c612cf37f9bca78f62415bb36c12e11e9937ee: Change-Id founddf936b8c55ced642b7345a9bfe7a0eb9224a0a0f: Change-Id found1eaccf9d4cb90a9cf84f05fbba53ba1fb6ee72d3: Change-Id found3f654fc1ec696baa94ee22628ee74faf8bc58da8: Change-Id foundc2543620e601e66cfea829b9dffd5b4b401ad843: Change-Id found29beef3cedcb55515071f091b87236a816fd0105: Change-Id foundb0e0fdd63a1aa46472102f67b163ba524348d812: Change-Id found0db39249b733c8e3ebe291c368f9ddf839b0a252: Change-Id found154965e9bff11e09fb32a6927babadffe426bb67: Change-Id found85a72c761ea3fb1681d34bfa790d32d13d533336: Change-Id found3503a78289b6e12f0eef69bee2c499370d5fbb3f: Change-Id foundbe7669b7d8fc757b2787ec588ea0de67358014c8: Change-Id found\n\nIf the change-id is missing, copy commit-msg to .git\\hooks\\\n\n\nthen, run the following command to add the change id\ngit rebase -i --root↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓pick 75557aeeeaa272fed582d6154f214a1bcd1bf2a5pick 9e5bf10c39a2655a0aa4dead56a91be785f34e9c...↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓edit 75557aeeeaa272fed582d6154f214a1bcd1bf2a5edit 9e5bf10c39a2655a0aa4dead56a91be785f34e9c...git commit --amendgit rebase --continue↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓$ git rebase --continueSuccessfully rebased and updated refs/heads/master.\n\n3. Git stash (quick reference)3.1 Save changes to stash\ngit stash push: temporarily store the changes on the stash stack\n\n-m: add a description for this stash\n\nchanges file path: the path(s) of the files you want to stash\ngit stash push -m &quot;stash for Dispatcher, FwVol, Image, PeiMain changes&quot;   MdeModulePkg/Core/Pei/Dispatcher/Dispatcher.c MdeModulePkg/Core/Pei/FwVol/FwVol.c\n\n3.2 List stashes\ngit stash list: use this command to check all stash object\ngit stash list↓↓↓↓↓↓↓↓↓↓↓↓↓↓stash@&#123;0&#125;: On branch-name: stash for Dispatcher, FwVol, Image, PeiMain changes\n\n3.3 Apply or pop a stash\ngit stash pop: recover the stash and remove it from the stash list\n\ngit stash apply: recover the stash and keep it in the stash list\ngit stash pop stash@&#123;0&#125;git stash apply stash@&#123;0&#125;\n\n3.4 Drop a stash\ngit stash drop: delete a stash (for example one you already recovered with git stash apply)\ngit stash drop stash@&#123;0&#125;\n\n4. Find large objects&#x2F;files in repository historyWhen a push or hosting-side check fails due to large files, or when you want to reduce repo size, follow these steps to identify big objects and map them back to filenames.\n\nSave a list of all objects (object id with optional path):\ngit rev-list --objects --all &gt; all_objects.txt\n\nInspect pack file contents and sort by packed size (creates a list of objects and their packed sizes):\ngit verify-pack -v .git/objects/pack/pack-*.idx | sort -k3 -n &gt; pack_sizes.txt\n\nShow the largest packed objects (for example, last 10 entries):\ntail -n 10 pack_sizes.txt\n\nOnce you identify an object ID (SHA-1) listed in pack_sizes.txt, locate the corresponding filename(s) by searching the repository object list. For example, use the command below to show the filename:\ngit rev-list --objects --all | grep 238631fd63d9b129c04efdd6e8dc136d9ed410e6\n\nThe pipeline above (verify-pack → sort → tail → rev-list&#x2F;grep) lets you find big objects and then locate the path(s) that reference those objects. After identifying large files, you can remove them from history using tools such as git filter-repo or the BFG Repo-Cleaner if you need to reduce repository size.\n\n\n","categories":["Git"],"tags":["Git"]},{"title":"[脚本] 利用OneDrive实时同步零碎文件","url":"/2023/03/10/Others/%E3%80%90%E8%84%9A%E6%9C%AC%E3%80%91%E5%88%A9%E7%94%A8OneDriver%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5%E9%9B%B6%E7%A2%8E%E6%96%87%E4%BB%B6/%E5%88%A9%E7%94%A8OneDriver%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5%E9%9B%B6%E7%A2%8E%E6%96%87%E4%BB%B6/","content":"\n本主题用于记录利用OneDrive实时同步零碎文件的步骤。\n\n最近在写论文，阅读了大量的文献，在这期间利用稻壳阅读器(DocBox)在阅读的同时也做了一些笔记，可恨是在登录稻壳阅读器后，对于这些圈圈画画的笔记进行异地同步居然还要付费，因此再想办法怎么既可以达成同步的需求，又可以免费白嫖呢？\n于是，一个同步文件的脚本就是我需要的了，主逻辑就是找到DocBox中关然后于笔记文件的存放点，然后实时监测这些笔记的生成和更新，如果有发现这种行为的发生，就把有变动的文件同步到OneDrive，同样的，如果发现OneDrive上有更新的变动文件，也会同步到DocBox中(同步前会判断云端和本地的文件是否有差异，以避免错误覆盖)。同理，在异地使用DocBox时，也运行这个脚本就可以了，这就节省了大量的实际去同步这些零碎的问题。\n拓展开来，可以利用这种方式实时同步所有需要的文件，而无需人为手动干预。\n源代码：\nimport osimport timeimport shutilimport filecmpimport datetimefrom watchdog.observers import Observerfrom watchdog.events import FileSystemEventHandler  def FileCopy(FilePath):    filename = FilePath.split(&#x27;/&#x27;)[-1]    original = FilePath.replace(filename, &#x27;&#x27;)     if original == path1:        destination = path2    else:        destination = path1     if os.path.exists(destination + filename):        if filecmp.cmp(FilePath, destination + filename):            print(&quot;[&quot; + original + &quot;] 与 [&quot; + destination + &quot;] 下的 (&quot; + filename + &quot;) 相同，无需操作&quot;)        else:            shutil.copy(FilePath, destination)            print(&quot;[&quot; + original + &quot;] 与 [&quot; + destination + &quot;] 下的 (&quot; + filename + &quot;) 不同，需要覆写&quot;)    else:        shutil.copy(FilePath, destination)        print(&quot;[&quot; + original + &quot;] 下新建了 (&quot; + filename + &quot;) ，已同步复制到 [&quot; + destination + &quot;]&quot;)  def FileRemove(FilePath):    filename = FilePath.split(&#x27;/&#x27;)[-1]    original = FilePath.replace(filename, &#x27;&#x27;)     if original == path1:        destination = path2    else:        destination = path1     if os.path.exists(destination + filename):        os.remove(destination + filename)        print(            &quot;已删除 [&quot; + original + &quot;] 下的 (&quot; + filename + &quot;) ，同步删除 [&quot; + destination + &quot;] 下的 (&quot; + filename + &quot;)&quot;)    else:        print(            &quot;已删除 [&quot; + original + &quot;] 下的 (&quot; + filename + &quot;) ，但 [&quot; + destination + &quot;] 下无 (&quot; + filename + &quot;)，因此无需操作&quot;)  class MyEventHandler(FileSystemEventHandler):     def __init__(self):        FileSystemEventHandler.__init__(self)     def on_any_event(self, event):         print(&quot;-----&quot;)        print(datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S.%f&#x27;))     # 移动    def on_moved(self, event):         if event.is_directory:            print(&quot;目录 moved:&#123;src_path&#125; -&gt; &#123;dest_path&#125;&quot;.format(src_path=event.src_path, dest_path=event.dest_path))        else:            print(&quot;文件 moved:&#123;src_path&#125; -&gt; &#123;dest_path&#125;&quot;.format(src_path=event.src_path, dest_path=event.dest_path))     # 新建    def on_created(self, event):         &quot;&quot;&quot;        if event.is_directory:            print(&quot;目录 created:&#123;file_path&#125;&quot;.format(file_path=event.src_path))        else:            print(&quot;文件 created:&#123;file_path&#125;&quot;.format(file_path=event.src_path))        &quot;&quot;&quot;        FileCopy(event.src_path)     # 删除    def on_deleted(self, event):         &quot;&quot;&quot;        if event.is_directory:            print(&quot;目录 deleted:&#123;file_path&#125;&quot;.format(file_path=event.src_path))        else:            print(&quot;文件 deleted:&#123;file_path&#125;&quot;.format(file_path=event.src_path))        &quot;&quot;&quot;        FileRemove(event.src_path)     # 修改    def on_modified(self, event):         &quot;&quot;&quot;        if event.is_directory:            print(&quot;目录 modified:&#123;file_path&#125;&quot;.format(file_path=event.src_path))        else:            print(&quot;文件 modified:&#123;file_path&#125;&quot;.format(file_path=event.src_path))        &quot;&quot;&quot;        FileCopy(event.src_path)  if __name__ == &#x27;__main__&#x27;:     path1 = &quot;C:/Users/sam_diao/AppData/Roaming/DocBox/xdmcache/&quot;    path2 = &quot;C:/Users/sam_diao/OneDrive/DocBox/xdmcache/&quot;     files = os.listdir(path2)    for i in range(0, len(files)):        if os.path.exists(path1 + files[i]):            if filecmp.cmp(path2 + files[i], path1 + files[i]):                print(&quot;[&quot; + path1 + &quot;] 与 [&quot; + path2 + &quot;] 下的 (&quot; + files[i] + &quot;) 相同，无需操作&quot;)            else:                shutil.copy(path2 + files[i], path1)                print(&quot;[&quot; + path1 + &quot;] 与 [&quot; + path2 + &quot;] 下的 (&quot; + files[i] + &quot;) 不同，需要覆写&quot;)        else:            shutil.copy(path2 + files[i], path1)            print(                &quot;[&quot; + path2 + &quot;] 下新增 (&quot; + files[i] + &quot;) 而 [&quot; + path1 + &quot;] 下无 (&quot; + files[i] + &quot;) 因此，需要复制 (&quot; +                files[i] + &quot;) 到 [&quot; + path1 + &quot;]&quot;)     myEventHandler = MyEventHandler()     # 观察者    observer1 = Observer()    observer2 = Observer()     # recursive:True 递归的检测文件夹下所有文件变化。    observer1.schedule(myEventHandler, path1, recursive=True)    observer2.schedule(myEventHandler, path2, recursive=True)     # 观察线程，非阻塞式的。    observer1.start()    observer2.start()     try:        while True:            time.sleep(1)    except KeyboardInterrupt:        observer1.stop()        observer2.stop()     observer1.join()    observer2.join()\n\n实际过程：每次开机时设置脚本自动运行，脚本会在最开始的时候开始同步云端和本地文件，之后会一直静默监听，如果有发生变化的文件，会实时进行操作同步，用于保证整个工作期间，无需人员的干预。\n\n","categories":["脚本"],"tags":["脚本"]},{"title":"[UEFI] Configuring Bridge Networking for QEMU on Ubuntu","url":"/2025/05/01/Uefi/Configuring_Bridge_Networking_for_QEMU_on_Ubuntu/Configuring_Bridge_Networking_for_QEMU_on_Ubuntu/","content":"\nThis tutorial will guide you through setting up bridge networking for QEMU on Ubuntu, allowing your QEMU virtual machine to share the same network connection as your physical machine.\n\n1. OverviewThis guide provides step-by-step instructions on how to set up bridge networking for QEMU on Ubuntu. It covers:\n\nInstalling necessary tools for bridge networking configuration\nCreating and configuring bridge interface\nVerifying IP routing configuration\nConfiguring QEMU to use bridge networking\nRecovering original Ubuntu network\n\n\n2. Install Necessary ToolsFirst, install the tools required for configuring bridge networking and User Mode Linux (UML) utilities:\nsudo apt-get install bridge-utils  # Virtual bridge configuration toolssudo apt-get install uml-utilities # UML (User-mode Linux)\n\n\n3. Create and Configure the Bridge Interface3.1 Create the br0 Bridge InterfaceYou can create a new bridge interface using the ip command. If you already have a bridge interface, skip this step.\nsudo ip link add name br0 type bridge\n\n3.2 Add the Physical Network Interface to the BridgeAssuming your physical network interface is enp0s3, add it to the br0 bridge interface. This allows QEMU to share the network connection.\nsudo ip link set enp0s3 master br0\n\n3.3 Configure the Bridge Interface (br0) to Get an IP Address\nObtain a Dynamic IP Address:\nUse DHCP to get an IP address:\nsudo dhclient br0\n\nConfigure a Static IP Address:\nTo set a static IP, use the following commands, assuming the static IP is 192.168.77.163:\nsudo ip addr add 192.168.77.163/24 dev br0\n\nConfigure a tap Interface:\nsudo ip tuntap add dev tap0 mode tapsudo ip link set tap0 master br0\n\n3.4 Ensure Both the Bridge and Physical Network Interface Are UPsudo ip link set br0 upsudo ip link set enp0s3 upsudo ip link set tap0 up\n\n3.5 Check the IP Configuration of the Bridge InterfaceUse the following command to check if br0 has been assigned an IP address:\nip addr show br0\n\nIf the bridge is configured correctly, you should see the IP address assigned to br0, and the QEMU virtual machine should be able to access the same network as the physical machine.\n3.6 Check if the Physical Network Interface enp0s3 Is Associated with the BridgeRun the following command to check if enp0s3 is correctly added to the bridge br0:\nip addr show\n\nYou should see output similar to this:\n1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever    inet6 ::1/128 scope host        valid_lft forever preferred_lft forever2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master br0 state UP group default qlen 1000    link/ether 08:00:27:39:5c:2c brd ff:ff:ff:ff:ff:ff    inet 192.168.77.119/24 brd 192.168.77.255 scope global noprefixroute enp0s3       valid_lft forever preferred_lft forever    inet6 fe80::4c94:9b80:38a0:cea1/64 scope link noprefixroute        valid_lft forever preferred_lft forever12: tap0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc fq_codel state DOWN group default qlen 1000    link/ether d2:20:61:63:21:f9 brd ff:ff:ff:ff:ff:ff14: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000    link/ether 46:5d:c4:0f:f8:80 brd ff:ff:ff:ff:ff:ff    inet 192.168.77.163/24 brd 192.168.77.255 scope global dynamic br0       valid_lft 86121sec preferred_lft 86121sec    inet6 fe80::e6aa:8ec2:3b62:2d9f/64 scope link noprefixroute        valid_lft forever preferred_lft forever\n\nAs shown, both br0 and enp0s3 should have their own IP addresses, and the status should be UP.\nSure, here’s a more detailed version of the “Verify IP Routing” section:\n\n3.7 Verify IP RoutingAfter setting up the bridge and configuring your network interfaces, it’s important to verify the IP routing configuration to ensure that the traffic will correctly flow through the bridge network.\n3.7.1 View Current Routing TableTo view the current routing table, use the following command:\nip route show\n\nThis command will display the routing information for your system. The expected output might look something like this:\nubuntu@ubuntu-VirtualBox:~$ ip route showdefault via 192.168.77.1 dev br0 default via 192.168.77.1 dev enp0s3 proto static metric 100 169.254.0.0/16 dev enp0s3 scope link metric 1000 192.168.77.0/24 dev br0 proto kernel scope link src 192.168.77.163 192.168.77.0/24 dev enp0s3 proto kernel scope link src 192.168.77.119 metric 100\n\n3.7.2 Explanation of the Routing Table\ndefault via 192.168.77.1 dev br0: This shows the default route for all outbound traffic, which is routed through the bridge interface br0 to the gateway 192.168.77.1.\n\ndefault via 192.168.77.1 dev enp0s3 proto static metric 100: This indicates another default route but routed through the physical network interface enp0s3. It’s using static routing, and the metric is set to 100, which is a relatively lower priority for this route.\n\n169.254.0.0/16 dev enp0s3 scope link metric 1000: This represents the link-local network, which is used when a system cannot obtain an IP address via DHCP. It’s routed through enp0s3 and has a higher metric (1000) to indicate lower priority.\n\n192.168.77.0/24 dev br0 proto kernel scope link src 192.168.77.163: This route indicates that the br0 interface is handling the 192.168.77.0/24 subnet.\n\n192.168.77.0/24 dev enp0s3 proto kernel scope link src 192.168.77.119 metric 100: This indicates that the enp0s3 interface is handling the same subnet but with a different IP address and lower priority.\n\n\n3.7.3 Adjusting the Routing TableIn some cases, after setting up a bridge, you may need to adjust the default route. For example, you may want to ensure that the default gateway (192.168.77.1) is routed via the bridge interface (br0) instead of the physical network interface (enp0s3).\nYou can achieve this by first deleting the previous default route through enp0s3:\nsudo ip route del default via 192.168.77.1 dev enp0s3\n\nThis will remove the old route pointing to enp0s3. Afterward, add a new default route through the bridge interface (br0), ensuring the traffic goes through the bridge:\nsudo ip route add default via 192.168.77.1 dev br0 metric 425\n\nHere, we set a metric of 425 for the new default route, ensuring that it has a higher priority than other routes (lower metric values have higher priority).\n3.7.4 Restart Network ManagerAfter modifying the routes, restart the network service to ensure that all changes take effect properly:\nsudo systemctl restart NetworkManager\n\n3.7.5 Verify Updated Routing TableOnce you’ve made these adjustments, check the routing table again to confirm that the default route is now correctly set to br0. The updated output should look like this:\nubuntu@ubuntu-VirtualBox:~$ ip route showdefault via 192.168.77.1 dev br0 default via 192.168.77.1 dev br0 proto dhcp metric 425 169.254.0.0/16 dev enp0s3 scope link metric 1000 192.168.77.0/24 dev br0 proto kernel scope link src 192.168.77.163 192.168.77.0/24 dev enp0s3 proto kernel scope link src 192.168.77.119 metric 100 192.168.77.0/24 dev br0 proto kernel scope link src 192.168.77.163 metric 425\n\n\ndefault via 192.168.77.1 dev br0: The primary default route now uses the bridge interface br0 as the gateway.\n\ndefault via 192.168.77.1 dev br0 proto dhcp metric 425: This confirms the DHCP-assigned default route through the bridge with the updated metric of 425.\n\n\nBy following these steps, you ensure that your system uses the bridge network as the primary route for all outbound traffic, making it share the same network as the host machine.\n3.7.6 Disable Firewallsudo ufw disable\n\n\n4. Configure QEMU to Use Bridge NetworkingNow that you’ve created and configured the bridge interface, configure QEMU to use it.\n4.1 Configure the bridge.conf Filecd /usr/local/etc/sudo mkdir qemucd qemusudo vim bridge.conf# Fill in the value and save in bridge.conf: allow br0\n\n\n5. Start the QEMU Virtual Machine Using Bridge NetworkingUse the -netdev bridge and -device options to configure the virtual machine to use bridge networking. Here’s an example command:\nsudo qemu-system-x86_64 \\-drive if=pflash,format=raw,file=OVMF.fd,id=BIOS-OVMF \\-drive file=fat:rw:hda-contents,format=raw,if=ide,index=0 \\-netdev bridge,id=net0,br=br0 \\-device e1000,netdev=net0 \\-cpu Penryn,+rdrand \\-debugcon file:debug.log \\-global isa-debugcon.iobase=0x402 \\-s\n\nThis command starts a QEMU virtual machine with the br0 bridge network, and e1000 is the network adapter used within the virtual machine.\n\n6. Recovering Original Ubuntu NetworkIf you need to remove the bridge interface (br0), follow these additional steps:\n\nShut Down the tap0 Interface\nBring the tap0 interface down:\nsudo ip link set tap0 down\n\nDelete the tap0 Interface\nDelete the tap0 interface. You can use the following command:\nsudo ip tuntap del tap0 mode tap\n\nIf this command shows an error, try this alternative command to delete tap0:\nsudo ip link delete tap0\n\nShut Down the br0 Bridge\nBring the br0 interface down:\nsudo ip link set br0 down  # Shut down br0 bridge\n\nDelete the Bridge\nDelete the br0 bridge:\nsudo brctl delbr br0  # Delete the br0 bridge\n\nUnbind the enp0s3 Network Interface\nMake sure enp0s3 is no longer associated with the bridge:\nsudo ip link set enp0s3 nomaster  # Unbind enp0s3 from the br0 bridge\n\nRestart Network Services\nIf the interface is still not functioning, restarting the networking service can help:\nsudo systemctl restart NetworkManager\n\nObtain a New IP Address\nAfter removing the bridge and unbinding the interface, try obtaining a new IP address using DHCP:\nsudo dhclient enp0s3\n\nCheck Network Status\nCheck the status of the enp0s3 interface to ensure it has returned to normal:\nip addr show enp0s3\n\n\nThis guide provides a complete and detailed explanation for setting up bridge networking in QEMU on Ubuntu, and also how to remove the bridge setup when no longer needed.\n","categories":["UEFI"],"tags":["UEFI"]},{"title":"[Code] 关于编译、汇编和链接","url":"/2024/02/15/Others/%E5%85%B3%E4%BA%8E%E7%BC%96%E8%AF%91%E3%80%81%E6%B1%87%E7%BC%96%E5%92%8C%E9%93%BE%E6%8E%A5/%E5%85%B3%E4%BA%8E%E7%BC%96%E8%AF%91%E3%80%81%E6%B1%87%E7%BC%96%E5%92%8C%E9%93%BE%E6%8E%A5/","content":"\n本主题用于记录什么是编译、汇编和链接。\n\n1. GCC的命令格式gcc [options] [filenames]\n\n\n\n\n序号\n选项\n含义\n\n\n\n1\n-E\n只做预处理\n\n\n2\n-c\n只做编译，不进行链接，目的是为了生成目标文件‘.o’\n\n\n3\n-S\n生成汇编代码\n\n\n4\n-o file\n将输出生成的内容保存至file描述的的文件中\n\n\n5\n-g\n在输出文件中加入支持调试的信息\n\n\n6\n-v\n显示输出详细的命令执行过程信息\n\n\n2. GCC的执行步骤\n1、编译(cc1,cc1是C语言的编译器)：编译器完成“预处理”和“编译”，“预处理”主要指的是处理源文件中以“#”开头的预处理指令，比如#include、#define等；“编译”则针对预处理的结果进行一系列的词法分析、语法分析、语义分析，优化后生成汇编指令，存放在.o为后缀的目标文件中。\n2、汇编(as)：汇编器将汇编语言代码转换为CPU可以执行的指令。\n3、链接(ld)：链接器将汇编器生成的目标文件和一些标准库(比如libc)文件组合，形成最终可执行的应用程序。\n3. ELF文件格式ELF文件格式简介\nLinux- 浅谈ELF目标文件格式\n  \n练习11、编写⼀个简单的打印 hello, world! 的程序源文件: hello.c\nvim hello.c\n\n2、对源文件进⾏本地编译，⽣成针对⽀持x86\\_64指令集架构处理器的⽬标文件hello.o\ngcc -c hello.c -o hello.o\n\n其中-o hello.o可以省略，不指定输出文件名的话，会默认生成同名的hello.o\n  \n3、查看hello.o的文件的文件头信息\nreadelf -h hello.o\n\n  \n4、查看hello.o的Section header table\nreadelf -SW hello.o\n\n  \n5、对hello.o反汇编，并查看hello.c的C程序源码和机器指令的对应关系\ngcc -g -c hello.cobjdump -S hello.o\n\n  \n练习2#include &lt;stdio.h&gt;    int global_init = 0x11111111;    const int global_const = 0x22222222;void main()&#123;    static int static_var = 0x33333333;    static int static_var_uninit;    int auto_var = 0x44444444;    printf(&quot;hello world!\\n&quot;);    return;&#125;\n\nQ:请问编译为.o文件后，global\\_init, global\\_const, static\\_var, static\\_var\\_uninit, auto\\_var这些变量分别存放在那些section⾥，&quot;hello world!\\n&quot;这个字符串⼜在哪⾥？\nA:global\\_init：存放在.data中。由于它被初始化了，所以会存放在.data中。global\\_const：存放在.rodata中，因为它是一个常量，不可修改。static\\_var：存放在.data中。由于它是一个静态变量且被初始化了，所以会存放在.data中。static\\_var\\_uninit：存放在.bss中，因为它是一个静态变量但未被初始化，.bss存放未初始化的全局和静态变量。auto\\_var：在函数内部声明的局部变量通常存放在栈上，而不是.o文件中的sections中。&quot;hello world!\\n&quot;：存放在.rodata中，因为它是一个常量字符串，不可修改。\n验证：\n&gt; gcc -g -c test.c&gt; objdump -S test.o&gt; objdump -s test.o\n\n\n\n\n如上所示：int global_init = 0x11111111，static int static_var = 0x33333333，存放在.data中。const int global_const = 0x22222222，__”hello world!\\n”__，存放在.rodata中。static int __static_var_uninit__，未被初始化，但int类型的变量通常占用4个字节，因此可以合理确认存放在.bss中。int auto_var = 0x44444444，存放在堆栈上，可以看到被放置在rbp指向的地址。\n","categories":["Code"],"tags":["Code"]},{"title":"[UEFI] Debug OVMF with Intel UDK Debugger","url":"/2025/02/20/Uefi/Intel_UDK_Debugger/Intel_UDK_Debugger/","content":"\nThis topic is used to record how to use Intel UDK Debugger on Linux for debugging OVMF and UEFI applications.\n\n1. OverviewThis guide provides step-by-step instructions on how to use the Intel UDK Debugger on Linux to debug OVMF (Open Virtual Machine Firmware) and UEFI applications. It covers:\n\nChecking GDB configuration and installing Intel UDK Debugger\nAdding CPU breakpoints to source code\nBuilding OVMF with debugging support\nIntegrating debugging with QEMU and Intel UDK Debugger\nDebugging with GDB and Intel UDK Debugger\n\n\n2. Check GDB and Install Intel UDK DebuggerBefore starting, ensure that your GDB supports --with-expat. If not, upgrade GDB to a compatible version.\nRun the following command to check GDB configuration:\ngdb -configuration\n\nExample output:\nThis GDB was configured as follows:   configure --host=x86_64-linux-gnu --target=x86_64-linux-gnu      --with-auto-load-dir=$debugdir:$datadir/auto-load      --with-auto-load-safe-path=$debugdir:$datadir/auto-load      --with-expat      --with-gdb-datadir=/usr/share/gdb (relocatable)      --with-jit-reader-dir=/usr/lib/gdb (relocatable)      --without-libunwind-ia64      --with-lzma      --with-babeltrace      --with-intel-pt      --with-mpfr      --with-xxhash      --with-python=/usr (relocatable)      --with-python-libdir=/usr/lib (relocatable)      --with-debuginfod      --without-guile      --enable-source-highlight      --with-separate-debug-dir=/usr/lib/Debug (relocatable)      --with-system-gdbinit=/etc/gdb/gdbinit      --with-system-gdbinit-dir=/etc/gdb/gdbinit.d\n\nIf --with-expat is present, proceed to install the Intel UDK Debugger.\n\n2.1 Install Intel UDK Debugger\nMake the installer executable:\nsudo chmod +x UDK_Debugger_Tool_v1_5_1.bin\n\nRun the installer:\nsudo ./UDK_Debugger_Tool_v1_5_1.bin\n\nFollow the installation prompts as shown in the screenshots below:\n\n\n3. Add CpuBreakpoint() to the Source CodeTo enable debugging, insert a CPU breakpoint in the UEFI application’s source code. For example, in Debug_Main.c:\n// Insert a CPU breakpoint for debugging. This will cause the debugger to break execution at this point.CpuBreakpoint ();\n\n\n4. Build OVMF and Debug_Main.efiTo include the Debug_Main application in OVMF, modify the edk2/OvmfPkg/OvmfPkgX64.dsc file as follows:\n4.1 Modify OvmfPkgX64.dscAdd the following lines to the [Components] section:\n[Components]  SamModulePkg/Applications/DemoApp/Debug_Main/Debug_Main.inf\n\nEnable source-level debugging by adding:\nDEFINE SOURCE_DEBUG_ENABLE = TRUE\n\nMove the PcdFSBClock setting from [PcdsDynamicDefault] to [PcdsFixedAtBuild]:\n[PcdsFixedAtBuild]  gEfiMdePkgTokenSpaceGuid.PcdFSBClock|1000000000\n\n4.2 Build OVMFRun the following command to build OVMF with debugging support:\nbuild -p OvmfPkg/OvmfPkgX64.dsc -t GCC5 -a X64 -b NOOPT -DSOURCE_DEBUG_ENABLE=TRUE -DDEBUG_ON_SERIAL_PORT=TRUE\n\nAfter building, copy the generated Debug_Main.efi and Debug_Main.debug files to the hda-contents folder.\n\n5. Integrate Debugging with QEMU and Intel UDK Debugger5.1 Create Pipes for CommunicationCreate named pipes for communication between QEMU and Intel UDK Debugger:\nmkfifo /tmp/serial.inmkfifo /tmp/serial.out\n\n5.2 Start Intel UDK DebuggerRun the following command to start the Intel UDK Debugger:\nsudo /opt/intel/udkdebugger/bin/udk-gdb-server\n\n5.3 Start GDBOpen a new terminal and start GDB:\ngdb\n\n5.4 Start QEMURun QEMU with the following command:\nqemu-system-x86_64 \\    -drive if=pflash,format=raw,file=OVMF.fd,id=BIOS-OVMF \\    -drive file=fat:rw:hda-contents,format=raw,if=ide,index=0 \\    -net none \\    -serial pipe:/tmp/serial\n\n\n\n6. Debugging with GDB and Intel UDK Debugger6.1 Connect GDB to Intel UDK DebuggerWhen QEMU starts, it will pause execution. In the GDB terminal, connect to the Intel UDK Debugger:\n(gdb) target remote ubuntu-VirtualBox:1234\n\n\n6.2 Continue to BootContinue to boot the QEMU into UEFI Shell:\n(gdb) c\n\n\n6.3 Load Debug SymbolsRun Debug_Main.efi and load the debug symbols for Debug_Main.efi:\n(gdb) source /opt/intel/udkdebugger/script/udk_gdb_script\n\n\n6.4 View Source CodeTo view the source code of Debug_Main.efi, run:\nl Debug_Main\n\n\n6.5 Step Through CodeUse the following commands to step through the code:\n\nn (next): Execute the next line of code.\nc (continue): Continue execution until the next breakpoint.\n\n\n6.6 Inspect VariablesTo inspect the value of a variable, use:\np &lt;variable_name&gt;\n\n\n6.7 Complete ExecutionTo allow the application to complete execution, run:\nc\n\n\n\n7. Additional ResourcesFor more detailed instructions, refer to the UDK_Debugger_Tool_User_Manual.\n","categories":["UEFI","Intel UDK Debugger"],"tags":["UEFI","Intel UDK Debugger"]},{"title":"[UEFI] Debug OVMF with GDB","url":"/2025/02/24/Uefi/GDB_Debug/GDB_Debug/","content":"\nThis topic is used to record how to dump debug logs and debug UEFI firmware on OVMF using GDB with QEMU.\n\n1. OverviewThis guide explains how to dump debug logs when debugging on OVMF (Open Virtual Machine Firmware). It covers:\n\nAdding a debug application to OVMF\nBuilding the firmware in DEBUG mode\nRunning QEMU with debug logging enabled\nUsing GDB for remote debugging with symbol loading\nAccessing debug output through the UEFI Shell\n\n\n2. Add Debug_Main.inf to OVMFTo include the Debug_Main application in OVMF, add the following line to the [Components] section of either edk2/OvmfPkg/OvmfPkgIa32.dsc or edk2/OvmfPkg/OvmfPkgX64.dsc:\n[Components]  SamModulePkg/Applications/DemoApp/Debug_Main/Debug_Main.inf\n\n\n3. Build OVMFRun one of the following commands to build OVMF with the Debug_Main application:\n\nFor X64 architecture:\nbuild -p OvmfPkg/OvmfPkgX64.dsc -t GCC5 -a X64 -b DEBUG\n\nFor IA32 architecture:\nbuild -p OvmfPkg/OvmfPkgIa32.dsc -t GCC5 -a IA32 -b DEBUG\n\nAfter building, copy the generated Debug_Main.efi and Debug_Main.debug files to either disk.img or the hda-contents folder.\n\n4. Run QEMUOption 1: Using disk.imgRun the following command to start QEMU with a USB storage device:\nqemu-system-x86_64 \\    -drive if=pflash,format=raw,file=OVMF.fd,id=BIOS-OVMF \\    -drive if=none,format=raw,file=disk.img,id=usb-drive \\    -device usb-ehci,id=usb-ehci \\    -device usb-storage,drive=usb-drive,bus=usb-ehci.0 \\    -debugcon file:debug.log \\    -global isa-debugcon.iobase=0x402 \\    -nographic \\    -net none \\    -s\n\nOption 2: Using hda-contentsRun the following command to start QEMU with an IDE storage device:\nqemu-system-x86_64 \\    -drive if=pflash,format=raw,file=OVMF.fd,id=BIOS-OVMF \\    -drive file=fat:rw:hda-contents,format=raw,if=ide,index=0 \\    -debugcon file:debug.log \\    -global isa-debugcon.iobase=0x402 \\    -nographic \\    -net none \\    -s\n\n\n5. Run Debug_Main.efiAfter starting QEMU, run the Debug_Main.efi application. If everything works correctly, you should see output similar to the following:\n\n\n6. Debug with GDBIn debug.log, after executing Debug_Main.efi, the driver is loaded at address 0x00006700000:\nline 1647: Loading driver at 0x00006700000 EntryPoint=0x0000670117A Debug_Main.efi\n\nAfter running QEMU with the -s option, GDB can be used for debugging.\n6.1 Start GDB and Load SymbolsRun GDB in the folder where you set the Debug_Main.efi:\nubuntu@ubuntu-VirtualBox:/media/sf_Share/UEFI/Individual/Debuger/hda-contents/ia32$ gdb\n\nWithin GDB:\n(gdb) file Debug_Main.efiReading symbols from Debug_Main.efi...(No debugging symbols found in Debug_Main.efi)\n\nVerify that the symbols are loaded:\n(gdb) info filesSymbols from &quot;/media/sf_Share/UEFI/Individual/Debuger/hda-contents/ia32/Debug_Main.efi&quot;.Local exec file: `/media/sf_Share/UEFI/Individual/Debuger/hda-contents/ia32/Debug_Main.efi&#x27;, file type pei-i386. Entry point: 0x117a 0x00000240 - 0x00002040 is .text 0x00002040 - 0x00002140 is .data 0x00002140 - 0x00002280 is .reloc\n\n\n6.2 Calculate the Address OffsetsUse the previously obtained load address from debug.log and add the section offsets:\n\nText section: 0x00006700000 + 0x0240 = 0x00006700240\nData section: 0x00006700240 + 0x2040 = 0x00006702280\n\n6.3 Unload Debug_Main.efiTo ensure a clean state before reloading the symbol file, use the following GDB command:\n(gdb) fileNo executable file now.No symbol file now.\n\n6.4 Load Debug SymbolsAfter unloading the previous executable, load the symbol file for Debug_Main:\n(gdb) add-symbol-file Debug_Main.debug 0x00006700240 -s .data 0x00006702280add symbol table from file &quot;Debug_Main.debug&quot; at .text_addr = 0x6700240 .data_addr = 0x6702280(y or n) yReading symbols from Debug_Main.debug...\n\nThis command tells GDB to load the debug symbols from Debug_Main.debug, and the offsets for the .text and .data sections are provided.\n6.5 Set BreakpointOnce the symbol file is loaded, set a breakpoint at the entry point of Debug_Main:\n(gdb) break Debug_MainBreakpoint 1 at 0x6701120: file /media/sf_Share/UEFI/edk2/SamModulePkg/Applications/DemoApp/Debug_Main/Debug_Main.c, line 27.\n\n6.6 Attach GDB to QEMUTo begin remote debugging, use the following command to connect GDB to QEMU:\n(gdb) target remote localhost:1234Remote debugging using localhost:1234warning: No executable has been specified and target does not supportdetermining executable automatically.  Try using the &quot;file&quot; command.0x0000000007166297 in ?? ()(gdb) cContinuing.\n\nGDB will connect to QEMU, and execution will continue until the breakpoint is hit.\n6.7 Restart Debug_Main.efi from the UEFI ShellAt this point, everything is set up. Go back to the UEFI Shell, and run Debug_Main.efi again. See the breakpoint hit in the code, and continue debugging.\nAfter the breakpoint is hit, type c (for continue) to let the program run. See debug output both in the UEFI Shell and in the debug.log.\n\nThe debug.log will now also contain new log entries corresponding to the actions performed in Debug_Main.efi:\n\n\n7. Notes\nEnsure that OVMF.fd, disk.img, or hda-contents are correctly configured and accessible.\nThe debug.log file will contain debug output from QEMU and can be used for troubleshooting.\nIf you encounter issues, verify that the Debug_Main.efi application is correctly built and copied to the appropriate location.\nUse objdump -x Debug_Main.efi to inspect symbol information.\n\n\nAppendix: Print Debug Information to UEFI ShellTo print debug information directly to the UEFI Shell, modify the dsc file as follows:\n[Components]  SamModulePkg/Applications/DemoApp/Debug_Main/Debug_Main.inf &#123;    &lt;LibraryClasses&gt;      DebugLib|MdePkg/Library/UefiDebugLibConOut/UefiDebugLibConOut.inf  &#125;\n\nThis change redirects debug output to the UEFI Shell console, like this:\nThis update moves the Print Debug Information to UEFI Shell section into an appendix and retains the clarity of the remaining guide for debugging OVMF with GDB.\n","categories":["UEFI","GDB"],"tags":["UEFI","GDB"]},{"title":"[UEFI] Windows下调试UEFI程序","url":"/2023/12/27/Uefi/Windows%E4%B8%8B%E8%B0%83%E8%AF%95UEFI%E7%A8%8B%E5%BA%8F/Windows%E4%B8%8B%E8%B0%83%E8%AF%95UEFI%E7%A8%8B%E5%BA%8F/","content":"\n本主题用于记录在 Windows 下调试UEFI程序。\n\n本文的调试代码均以edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\为例\n1. Windows下的调试方法1.1 使用Visual Studio 2019进行调试\n主逻辑：\n\n在VS2019中新建Makefile工程\n设置工程文件的目标路径\n修改工程文件的配置参数\n添加需要调试的代码\n编译代码并调试\n\n\n1.1.1 新建Makefile工程\n\n1.1.2 设置目标路径我放在C:\\\\UEFIWorkspace\\\\edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\下\n\n\n下方的needtomodfiy是在1.3节里会被修改的，可以直接理解成占位符。\n\n\n\n注：上方的工作目录需要格外注意两点：第一，尽量使用绝对路径；第二，地址后的’\\‘不能省略。\n1.1.3 修改工程文件\n找到Win32和X64下的NMakeBuildCommandLine、NMakeCleanCommandLine和NMakeReBuildCommandLine，把needtomodify部分按照如下修改：\n\n   &lt;PropertyGroup Condition=&quot;&#x27;$(Configuration)|$(Platform)&#x27;==&#x27;Debug|Win32&#x27;&quot;&gt;     &lt;NMakeBuildCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a IA32 -b DEBUG     &lt;/NMakeBuildCommandLine&gt;     &lt;NMakeOutput&gt;test.exe&lt;/NMakeOutput&gt;     &lt;NMakeCleanCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a IA32 -b DEBUG clean     &lt;/NMakeCleanCommandLine&gt;     &lt;NMakeReBuildCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a IA32 -b DEBUG clean       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a IA32 -b DEBUG     &lt;/NMakeReBuildCommandLine&gt;     &lt;NMakePreprocessorDefinitions&gt;WIN32;\\_DEBUG;$(NMakePreprocessorDefinitions)&lt;/NMakePreprocessorDefinitions&gt;   &lt;/PropertyGroup&gt;   &lt;PropertyGroup Condition=&quot;&#x27;$(Configuration)|$(Platform)&#x27;==&#x27;Release|Win32&#x27;&quot;&gt;     &lt;NMakeBuildCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a IA32 -b RELEASE     &lt;/NMakeBuildCommandLine&gt;     &lt;NMakeOutput&gt;test.exe&lt;/NMakeOutput&gt;     &lt;NMakeCleanCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a IA32 -b RELEASE clean     &lt;/NMakeCleanCommandLine&gt;     &lt;NMakeReBuildCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a IA32 -b RELEASE clean       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a IA32 -b RELEASE     &lt;/NMakeReBuildCommandLine&gt;     &lt;NMakePreprocessorDefinitions&gt;WIN32;NDEBUG;$(NMakePreprocessorDefinitions)&lt;/NMakePreprocessorDefinitions&gt;   &lt;/PropertyGroup&gt;   &lt;PropertyGroup Condition=&quot;&#x27;$(Configuration)|$(Platform)&#x27;==&#x27;Debug|X64&#x27;&quot;&gt;     &lt;NMakeBuildCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a X64 -b DEBUG     &lt;/NMakeBuildCommandLine&gt;     &lt;NMakeOutput&gt;test.exe&lt;/NMakeOutput&gt;     &lt;NMakeCleanCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a X64 -b DEBUG clean     &lt;/NMakeCleanCommandLine&gt;     &lt;NMakeReBuildCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a X64 -b DEBUG clean       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a X64 -b DEBUG     &lt;/NMakeReBuildCommandLine&gt;     &lt;NMakePreprocessorDefinitions&gt;X64;\\_DEBUG;$(NMakePreprocessorDefinitions)&lt;/NMakePreprocessorDefinitions&gt;   &lt;/PropertyGroup&gt;   &lt;PropertyGroup Condition=&quot;&#x27;$(Configuration)|$(Platform)&#x27;==&#x27;Release|X64&#x27;&quot;&gt;     &lt;NMakeBuildCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a X64 -b RELEASE     &lt;/NMakeBuildCommandLine&gt;     &lt;NMakeOutput&gt;test.exe&lt;/NMakeOutput&gt;     &lt;NMakeCleanCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a X64 -b RELEASE clean     &lt;/NMakeCleanCommandLine&gt;     &lt;NMakeReBuildCommandLine&gt;       cd /D C:\\\\UEFIWorkspace       set WORKSPACE=C:\\\\UEFIWorkspace       call mybuild.bat       call edk2\\\\edksetup.bat       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a X64 -b RELEASE clean       call build.bat -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a X64 -b RELEASE     &lt;/NMakeReBuildCommandLine&gt;     &lt;NMakePreprocessorDefinitions&gt;X64;NDEBUG;$(NMakePreprocessorDefinitions)&lt;/NMakePreprocessorDefinitions&gt;   &lt;/PropertyGroup&gt;\n\n1.1.4 添加代码添加HelloWorld.c到Source下\n\n1.1.5 编译代码并调试在代码处增加一处断点用于调试\n\nF5开始编译并调试，过程中注意观察log\n\n\n1.2 使用WINDBG进行调试\n主逻辑：\n\n安装WINDBG、QEMU、Intel UDK Debugger Tool、OSFMount、UltralSO\n创建QEMU虚拟硬盘\n编译OVMF镜像文件和HelloWorld.efi\n调试\n\n\n1.2.1 安装必要工具1.2.1.1 WINDBG我使用的WINDBG版本是6.12.0002.633，这个部分在最开始就装好，因为后续在安装Intel UDK Debugger Tool的时候会检测WINDBG是否存在，否则会无法安装。\n1.2.1.2 QEMU我使用的QEMU版本是0.13.0，记得要把QEMU的实际安装地址编写进环境变量里。\n\n1.2.1.3 Intel UDK Debugger ToolInstall地址不要修改，保持默认！\n\n设置Channel的时候要宣称Pipe，Port自定义为QemuPipeDbg。\n\n1.2.1.4 OSFMount、UltralSO我使用的OSFMount版本是3.1\n我使用的UltralSO版本是9.7.6.3829\n1.2.2 创建QEMU虚拟硬盘1.2.2.1 打开UltralSO创建硬盘镜像\n\n镜像大小根据自己的需要设定，我选择设定为512MB，然后将镜像另存为HDD_BOOT.IMA\n1.2.2.2 打开OSFMount挂载虚拟硬盘并导入调试程序\n\n\n\n\n挂载完毕如上，此时在我的电脑下会出现一个新的硬盘，盘符为HDD\\_BOOT。\n1.2.3 编译OVMF镜像文件和HelloWorld.efi(使用x86&#x2F;64 Native Tools Command Prompt for VS2019)1.2.3.1 编译OVMF镜像文件基于OVMF镜像镜像源码级调试，编译edk2\\\\OvmfPkg。\n32位：\nC:\\\\UEFIWorkspace&gt;build -p edk2\\\\OvmfPkg\\\\OvmfPkgIA32.dsc -t VS2019 -a IA32 -b NOOPT -D SOURCE\\_DEBUG\\_ENABLE\n\n64位：\nC:\\\\UEFIWorkspace&gt;build -p edk2\\\\OvmfPkg\\\\OvmfPkgX64.dsc -t VS2019 -a X64 -b NOOPT -D SOURCE\\_DEBUG\\_ENABLE\n\n1.2.3.2 编译HelloWorld.efi32位：\nC:\\\\UEFIWorkspace&gt;build -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a IA32\n\n64位：\nC:\\\\UEFIWorkspace&gt;build -p edk2\\\\MdeModulePkg\\\\MdeModulePkg.dsc -m edk2\\\\MdeModulePkg\\\\Application\\\\HelloWorld\\\\HelloWorld.inf -t VS2019 -a X64\n\n1.2.4 调试1.2.4.1 文件准备在UEFIWorkspace下新建一个文件夹并命名为QemuDebug。\n将32位或者64位的OVMF.fd复制到QemuDebug文件夹下。\n将32位或者64位的HelloWorld.efi复制到HDD\\_BOOT的盘符下，然后将HDD\\_BOOT.IMA复制到QemuDebug文件夹下，想偷懒的话可以直接将HDD\\_BOOT.IMA在1.2.2.1节中的另存为默认地址放置在QemuDebug文件夹下，这样就不需要再手动的搬移HDD\\_BOOT.IMA，做完这一步以后，把HDD\\_BOOT弹出，否则会在下面正式调试的时候报错。\n从QEMU的根目录下复制qemu-x86\\_64.bat到QemuDebug文件夹下，并修改这个批处理文件如下：\n\n即，注释掉最后一行，并添加新的命令，其中QemuPipeDbg要与1.2.1.3节中设置Pipe Port名称match：\nC:\\\\UEFIWorkspace\\\\Tools\\\\QEMU\\\\qemu-system-x86\\_64.exe -bios OVMF.fd -usbdevice disk:HDD\\_BOOT.IMA -serial pipe:QemuPipeDbg\n\n至此，文件准备完毕，QemuDebug文件夹下将会存在以下三个文件：\n\n1.2.4.2 开始调试运行Start WinDbg with Intel UDK Debugger Tool，UDK Debugger和WINDBG会一起弹出，如下：\n\n打开CMD，cd到C:\\\\UEFIWorkspace\\\\QemuDebug\\\\下，并运行qemu-x86\\_64.bat：\n\n此时，QEMU的窗口已经弹出，WINDBG也会很快connected并进入第一个断点，此时在command bar中输入g，用于继续运行，等待QEMU进入UEFI SHELL：\n\n\n为了要对HelloWorld.efi进行源码级调试，此时需要在WINDBG中暂时中断连接，并在command bar中输入bu helloworld，然后输入g继续连接：\n\n\n\n在UEFI SHELL下定位到FS0:，运行HelloWorld.efi\n\n此时可以看到，efi的源代码自己跳出了，并且断点在函数的第一行，此时输入g，继续运行\n\n 至此，整个WINDBG的通道就已经建立了，根据不同的函数自行调试即可。\n","categories":["UEFI"],"tags":["UEFI"]},{"title":"[UEFI] Windows和Linux下的环境搭建","url":"/2023/01/19/Uefi/Windows%E5%92%8CLinux%E4%B8%8B%E7%9A%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/Windows%E5%92%8CLinux%E4%B8%8B%E7%9A%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/","content":"\n本主题用于记录在 Windows 和 Linux 下搭建 UEFI 开发&#x2F;调试环境的步骤。\n\n1. Windows下的UEFI环境搭建\n主逻辑：\n① 下载EDK2及其它必要的开发包，并安装EDK2所需的开发工具(VS2019、Python、NASM、IASL、Git、Cygwin)② 配置EDK2开发环境③ 编译UEFI模拟器和示例程序④ 启动模拟器并运行编译好的示例程序\n\n1.1 安装EDK2所需的开发工具(基于Windows10 21H1 19043.1826)NASM、IASL、Cygwin和EDK2相关开发包我都放在了C盘根目录下的UEFIWorkspace文件夹中，其他工具安装位置自行决定\n1.1.1 C&#x2F;C++编译器(VS2019，因为目前的EDK2只支持到2019)https://learn.microsoft.com/zh-cn/visualstudio/releases/2019/redistribution#vs2019-download/\n在安装VS2019时要勾选CMake工具\n\n1.1.2 Python3(我安装的是3.9)https://www.python.org/\n1.1.3 NASM(2.15及以上)https://www.nasm.us/\n1.1.4 ASLhttps://acpica.org/downloads/binary-tools\n1.1.5 Githttps://git-scm.com/\n1.1.6 Cygwinhttp://www.cygwin.com/setup-x86_64.exe\n1.1.7 EDK2及其它必要开发包(通过Git工具下载)http://github.com/tianocore/edk2.githttp://github.com/tianocore/edk2-libc.git\n1.1.8 环境变量设置，如下\n\n 注：这里我就踩了坑，因为我有强迫症，为了保持所有工具安装位置的统一，我将所有工具都放在UEFIWorkspace\\Tools下，这时候对于ASL来说需要调整edk2\\BaseTools\\set_vsprefix_envs.bat中关于IASL_PREFIX的地址定义，如下：\n\n如果你不想单独修改地址定义，那你的ASL工具就必须装在C盘根目录中，否则会在后面的编译过程中遇到以下错误：\n\n1.2 配置EDK2开发环境1.2.1 更新EDK2 Submodule仅首次需要加 –init，以后再更新就不需要了，如果update失败的话，请看文末的注1\ngit submodule update --init\n\n1.2.2 编译BaseTools(使用x86&#x2F;64 Native Tools Command Prompt for VS2019)C:\\UEFIWorkspace\\edk2&gt;edksetup.bat Rebuild\n\n\n如果遇到上面的类型转换报错，请更换为32位的编译器重试\n1.2.3 设置开发工具地址(在UEFIWorkspace下新建mybuild.bat，并添加以下内容)set WORKSPACE=%CD%set EDK_TOOLS_PATH=%CD%\\edk2\\BaseToolsset CONF_PATH=%CD%\\edk2\\Confset PACKAGES_PATH=%CD%\\edk2;%CD%\\edk2-libc\n\n1.2.4 检查edk2&#x2F;Conf下的配置文件(主要是target.txt和tools_def.txt，前者包含编译的默认参数，后者规定了编译工具链)我根据自己的配置情况修改了target.txt中的以下两个参数：\n\n1.3 编译UEFI模拟器和UEFI程序(使用x86&#x2F;64 Native Tools Command Prompt for VS 2019)1.3.1 设置环境变量C:\\UEFIWorkspace&gt;mybuild.batC:\\UEFIWorkspace&gt;edk2\\edksetup.bat\n\n1.3.2 编译UEFI模拟器C:\\UEFIWorkspace&gt;build -p edk2\\EmulatorPkg\\EmulatorPkg.dsc -t VS2019 -a X64\n\n1.3.3 编译UEFI程序C:\\UEFIWorkspace&gt;build -p edk2-libc\\AppPkg\\AppPkg.dsc -t VS2019 -a\n\n1.4 用UEFI模拟器运行UEFI程序(使用x86&#x2F;64 Native Tools Command Prompt for VS 2019)1.4.1 运行UEFI模拟器C:\\UEFIWorkspace\\Build\\EmulatorX64\\DEBUG\\_VS2019\\X64&gt;WinHost.exe\n\n\n1.4.2 运行UEFI程序(以HelloWorld.efi为例)&gt; Shell&gt;fs0:&gt; FS0:\\&gt;HelloWorld.efi\n\n\n2. Linux下的UEFI环境搭建\n主逻辑：\n\n下载EDK2及其它必要的开发包，并安装EDK2所需的开发工具(Git、Python3、UUID-DEV、NASM、BISON、FLEX、GCC、MAKE)   UUID-DEV: 用于编译所需要的源文件   NASM: 用于编译X86汇编代码   BISON和FLEX: 用于编译ACPICA工具时使用\n配置Linux下开发环境\n编译UEFI模拟器和示例程序\n启动模拟器并运行编译好的示例程序\n\n\n2.1 安装EDK2所需的开发工具(基于Ubuntu 20.04.2 LTS)2.1.1 安装Git$ sudo apt install git$ git --versiongit version 2.25.1\n\n2.1.2 安装Python3$ sudo apt install python3  $ python3 --version  Python 3.8.10\n\n2.1.3 安装UUID-DEV、NASM、BISON、FLEXsudo apt install uuid-dev nasm bison flex\n\n2.1.4 安装GCC、MAKE$ sudo apt-get install build-essential$ gcc --versiongcc (Ubuntu 9.4.0-1ubuntu1~20.04.1) 9.4.0$ make --version  GNU Make 4.2.1\n\n2.1.5 下载EDK2和其他必要开发包我将所有的开发包都放置在了桌面上的UEFIWorkspace中，前两个用于编译UEFI程序，第三个用于编译ACPI工具\n~/Desktop/UEFIWorkspace$ git clone http://github.com/tianocore/edk2.git~/Desktop/UEFIWorkspace$ git clone http://github.com/tianocore/edk2-libc.git~/Desktop/UEFIWorkspace$ git clone http://github.com/acpica/acpica.git\n\n2.2 配置开发环境2.2.1 更新SubModule仅首次需要加 –init，以后再更新就不需要了，如果update失败的话，请看文末的注1\n~/Desktop/UEFIWorkspace/edk2$ git submodule update --init\n\n2.2.2 编译BaseTools~/Desktop/UEFIWorkspace$ make -C edk2/BaseTools\n\n踩坑，在编译中遇到下面截图的问题：\n\n最终经过检查发现这是python没有做映射，需要将python3映射到python指令上。\n~/Desktop/UEFIWorkspace$ sudo ln -s /usr/bin/python3 /usr/bin/python\n\n2.2.3 编译ACPICA~/Desktop/UEFIWorkspace$ make -C acpica/\n\n 踩坑，在编译ACPICA中遇到下面截图的问题：\n\n最终经过检查发现这是ACPICA的代码错误，在acpica的github request pull #821已经提供了解决办法，修改后即可正常编译通过了。\nactbl2: Fix compilation of ACPI_MADT_OEM_DATA on gcc and clang by heatd · Pull Request #821 · acpica&#x2F;acpica · GitHub\n\n2.2.4 设置开发工具地址(在UEFIWorkspace下新建myexport.sh，并添加以下内容)export WORKSPACE=$PWDexport PACKAGES_PATH=$PWD/edk2:$PWD/edk2-libcexport IASL_PREFIX=$PWD/acpica/generate/unix/bin/export PYTHON_COMMAND=/usr/bin/python3\n\n2.3 编译UEFI模拟器和UEFI程序2.3.1 编译UEFI模拟器~/Desktop/UEFIWorkspace$ source myexport.sh~/Desktop/UEFIWorkspace$ source edk2/edksetup.sh~/Desktop/UEFIWorkspace$ build -p edk2/EmulatorPkg/EmulatorPkg.dsc -t GCC5 -a X64\n\n踩坑，遇到下面这个问题，最终通过更新NASM到2.15或以上版本解决\n\n踩坑，遇到下面这个问题：\n\n\n解决方案：\nsudo apt-get install x11proto-xext-dev  sudo apt-get install libx11-devsudo apt-get install libxext-dev\n\n2.3.2 编译UEFI程序~/Desktop/UEFIWorkspace$ build -p edk2-libc/AppPkg/AppPkg.dsc -t GCC5 -a X64\n\n2.4 用UEFI模拟器运行UEFI程序2.4.1 运行UEFI模拟器~/Desktop/UEFIWorkspace/Build/EmulatorX64/DEBUG\\_GCC5/X64$ ./Host\n\n\n2.4.2 运行UEFI程序(以HelloWorld.efi为例)Shell&gt;fs0:FS0:\\&gt;HelloWorld.efi\n\n\n 注1 ：关于更新EDK2 Submodule失败的解决方案\n直接使用github源更新可能会因为网络太慢导致更新失败，此时可以修改edk2.gitmodules中的代码源来提高更新速度，如下：\n\n[submodule &quot;CryptoPkg/Library/OpensslLib/openssl&quot;]    path = CryptoPkg/Library/OpensslLib/openssl    #url = &lt;https://github.com/openssl/openssl&gt;    url = &lt;https://gitee.com/DiaoSuYu/openssl.git&gt;###################################################################################################[submodule &quot;SoftFloat&quot;]    path = ArmPkg/Library/ArmSoftFloatLib/berkeley-softfloat-3    #url = &lt;https://github.com/ucb-bar/berkeley-softfloat-3.git&gt;    url = &lt;https://gitee.com/DiaoSuYu/berkeley-softfloat-3.git&gt;###################################################################################################[submodule &quot;UnitTestFrameworkPkg/Library/CmockaLib/cmocka&quot;]    path = UnitTestFrameworkPkg/Library/CmockaLib/cmocka    #url = &lt;https://github.com/tianocore/edk2-cmocka.git&gt;    url = &lt;https://gitee.com/DiaoSuYu/edk2-cmocka.git&gt;###################################################################################################[submodule &quot;MdeModulePkg/Universal/RegularExpressionDxe/oniguruma&quot;]    path = MdeModulePkg/Universal/RegularExpressionDxe/oniguruma    #url = &lt;https://github.com/kkos/oniguruma&gt;    url = &lt;https://gitee.com/DiaoSuYu/oniguruma.git&gt;###################################################################################################[submodule &quot;MdeModulePkg/Library/BrotliCustomDecompressLib/brotli&quot;]    path = MdeModulePkg/Library/BrotliCustomDecompressLib/brotli    #url = &lt;https://github.com/google/brotli&gt;    url = &lt;https://gitee.com/DiaoSuYu/brotli.git&gt;###################################################################################################[submodule &quot;BaseTools/Source/C/BrotliCompress/brotli&quot;]    path = BaseTools/Source/C/BrotliCompress/brotli    #url = &lt;https://github.com/google/brotli&gt;    url = &lt;https://gitee.com/DiaoSuYu/brotli.git&gt;    ignore = untracked###################################################################################################[submodule &quot;RedfishPkg/Library/JsonLib/jansson&quot;]    path = RedfishPkg/Library/JsonLib/jansson    #url = &lt;https://github.com/akheron/jansson&gt;    url = &lt;https://gitee.com/DiaoSuYu/jansson.git&gt;###################################################################################################[submodule &quot;UnitTestFrameworkPkg/Library/GoogleTestLib/googletest&quot;]    path = UnitTestFrameworkPkg/Library/GoogleTestLib/googletest    #url = &lt;https://github.com/google/googletest.git&gt;    url = &lt;https://gitee.com/DiaoSuYu/googletest.git&gt;###################################################################################################[submodule &quot;UnitTestFrameworkPkg/Library/SubhookLib/subhook&quot;]    path = UnitTestFrameworkPkg/Library/SubhookLib/subhook    #url = &lt;https://github.com/Zeex/subhook.git&gt;    url = &lt;https://gitee.com/DiaoSuYu/subhook.git&gt;###################################################################################################[submodule &quot;MdePkg/Library/BaseFdtLib/libfdt&quot;]    path = MdePkg/Library/BaseFdtLib/libfdt    #url = &lt;https://github.com/devicetree-org/pylibfdt.git&gt;    url = &lt;https://gitee.com/DiaoSuYu/pylibfdt.git&gt;###################################################################################################[submodule &quot;MdePkg/Library/MipiSysTLib/mipisyst&quot;]    path = MdePkg/Library/MipiSysTLib/mipisyst    #url = &lt;https://github.com/MIPI-Alliance/public-mipi-sys-t.git&gt;    url = &lt;https://gitee.com/DiaoSuYu/public-mipi-sys-t.git&gt;###################################################################################################[submodule &quot;CryptoPkg/Library/MbedTlsLib/mbedtls&quot;]    path = CryptoPkg/Library/MbedTlsLib/mbedtls    #url = &lt;https://github.com/ARMmbed/mbedtls&gt;    url = &lt;https://gitee.com/DiaoSuYu/mbedtls.git&gt;  \n\n可以将需要用的子模块导入gitee，再通过gitee来下载，请注意上面的gitee仓库是我私有的，你们不能直接使用，需要导入到你们自己的gitee仓库，再尝试更新子模块。请尽量保证上方gitee与edk2的下载地址在同一个下载地址，原因是可能会出现在初始化子模块的时候出现clone账户与edk2的clone账户不同的问题。\n举一反三，其实整个搭建环境的所有github部分都可以导入到自己的gitee，用于提升下载速度，具体是否需要，自行按需评估。\n","categories":["UEFI"],"tags":["UEFI"]},{"title":"[UEFI] 使用Docker快速部署EDK2开发环境","url":"/2024/03/10/Uefi/%E4%BD%BF%E7%94%A8Docker%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2EDK2%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/%E4%BD%BF%E7%94%A8Docker%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2EDK2%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/","content":"\n使用Docker快速部署EDK2开发环境。\n\n最近换了OA，重新配置EDK2开发环境让我窒息，因此我决定把整个EDK2的开发环境打包在Docker镜像中，方便在不同设备上快速构建开发环境，也方便后续对开发环境镜像更新。\n1. Linux下的部署方法\n主逻辑：\n\n安装Docker，基于Ubuntu 20.04\n创建Dockerfile\n编译Docker镜像\n启动Docker容器\n\n\n1.1 安装Docker1.1.1 卸载旧版本 (如果适用)如果你之前安装过旧版本的 Docker，首先需要卸载它们。可以使用以下命令来执行卸载：\nsudo apt-get remove docker docker-engine docker.io containerd runc\n\n1.1.2 更新 apt 软件包索引确保你的系统上的 apt 软件包索引是最新的：\nsudo apt-get update\n\n1.1.3 安装依赖软件包Docker 需要一些依赖软件包来正常运行，你可以通过以下命令安装它们：\nsudo apt-get install -y \\apt-transport-https \\ca-certificates \\curl \\gnupg-agent \\software-properties-common\n\n1.1.4 添加 Docker 的官方 GPG 密钥添加 Docker 官方 GPG 密钥以验证下载的 Docker 软件包的完整性：\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\n\n1.1.5 添加 Docker APT 仓库添加 Docker APT 仓库以便于从它安装 Docker：\nsudo add-apt-repository \\ &quot;deb \\[arch=amd64\\] https://download.docker.com/linux/ubuntu\\ $(lsb\\_release -cs) \\ stable&quot;\n\n1.1.6 更新 apt 软件包索引再次更新 apt 软件包索引以确保你已经添加的 Docker 仓库已经被包含：\nsudo apt-get update\n\n1.1.7 安装 Docker安装 Docker 软件包：\nsudo apt-get install -y docker-ce docker-ce-cli containerd.io\n\n1.1.8 检查安装情况现在 Docker 已经安装完成。你可以通过运行以下命令来验证 Docker 是否已经正确安装：\nsudo docker --version\n\n\n1.2 创建Dockerfile构建Dockerfile有两种情况，1：拉取github上EDK2的最新source，并直接基于ubuntu20.04进行实时环境搭建并编译镜像；2：直接将本地已搭建好的EDK2的开发环境打包成镜像。我把两种方案都做一遍，但实际工作中只需要任选其一即可，没有优劣，看实际需要决定。\n1.2.1 拉取EDK2最新source并编译docker镜像在ubuntu的桌面上新建名为docker的文件夹并创建Dockerfile：\nmkdir dockercd docker/touch Dockerfile\n\n开始修改Dockerfile：\nsudo gedit Dockerfile\n\n复制下方内容并粘贴到Dockerfile中：\n# 使用基础的 Ubuntu 镜像FROM ubuntu:latest# 设置工作目录WORKDIR /workspace# 更新 apt 软件包索引并安装所需软件包RUN apt-get update &amp;&amp; apt-get install -y \\git \\python3 \\uuid-dev \\nasm \\bison \\flex \\build-essential \\x11proto-xext-dev \\libx11-dev \\libxext-dev# 下载 EDK2 及其他必要开发包  RUN git clone http://github.com/tianocore/edk2.git &amp;&amp; \\git clone http://github.com/tianocore/edk2-libc.git &amp;&amp; \\git clone http://github.com/acpica/acpica.git# 更新 SubModuleRUN cd edk2 &amp;&amp; git submodule update --init# 编译 BaseToolsRUN make -C edk2/BaseTools PYTHON\\_COMMAND=/usr/bin/python3# 编译 ACPICARUN make -C acpica/# 设置开发工具地址RUN echo &quot;export WORKSPACE=\\$PWD&quot; &gt;&gt; /workspace/myexport.sh &amp;&amp; \\ echo &quot;export PACKAGES\\_PATH=\\$PWD/edk2:\\$PWD/edk2-libc&quot;&gt;&gt; /workspace/myexport.sh &amp;&amp; \\ echo &quot;export IASL\\_PREFIX=/workspace/acpica/generate/unix/bin/&quot; &gt;&gt; /workspace/myexport.sh &amp;&amp; \\ echo &quot;export PYTHON\\_COMMAND=/usr/bin/python3&quot; &gt;&gt; /workspace/myexport.sh &amp;&amp; \\ echo &quot;source edk2/edksetup.sh&quot; &gt;&gt; /workspace/myexport.sh# 设置脚本可执行权限RUN chmod +x /workspace/myexport.sh# 设置环境变量ENV WORKSPACE=/workspaceENV PACKAGES\\_PATH=/workspace/edk2:/workspace/edk2-libcENV IASL\\_PREFIX=/workspace/acpica/generate/unix/bin/ENV PYTHON\\_COMMAND=/usr/bin/python3\n\n\n其实这个部分的逻辑就是之前我基于linux手动搭建开发环境的逻辑，只是通过Dockerfile的方式来自动完成，具体可以对比我之前的文章：[UEFI]Windows和Linux下的环境搭建\n1.2.2 打包本地开发环境并编译为镜像文件我的EDK2开发环境放置在_/home/dsy/Desktop/UEFIWorkspace/_下，在这个文件夹下创建Dockerfile：\ntouch Dockerfile\n\n开始修改Dockerfile：\nsudo gedit Dockerfile\n\n复制下方内容并粘贴到Dockerfile中：\n# 使用基础的 Ubuntu 镜像FROM ubuntu:latest# 设置工作目录WORKDIR /workspace# 更新 apt 软件包索引并安装所需软件包  RUN apt-get update &amp;&amp; apt-get install -y \\git \\python3 \\uuid-dev \\nasm \\bison \\flex \\build-essential \\x11proto-xext-dev \\libx11-dev \\libxext-dev# 将所需要的文件夹下的所有文件拷贝到容器的 /workspace 目录下  COPY edk2 /workspace/edk2COPY edk2-libc /workspace/edk2-libcCOPY edk2-platforms /workspace/edk2-platformsCOPY acpica /workspace/acpicaCOPY myexport.sh /workspace# 将当前文件夹下所有文件和文件夹都拷贝到容器的 /workspace 目录下  # COPY . /workspace\n\n\n需要明确，我的EDK2开发环境是放置在 /home/dsy/Desktop/UEFIWorkspace/ 下的，你们要确认自己的环境位置再针对修改上方路径。\n1.3 编译Docker镜像同样，我把刚刚1.2中的两种不同情况也分开编译。\n1.3.1 拉取EDK2的最新source并编译为镜像文件拉取EDK2的github source并编译为Docker镜像，命名为edk2\\_dev\\_env，版本号为1.0，前方的镜像命名必须为小写，缩写含义为(EDK2\\_Development\\_Environment)：\nsudo docker build -t edk2\\_dev\\_env:1.0 .\n\n\n1.3.2 打包本地开发环境并编译为镜像文件直接在_/home/dsy/Desktop/UEFIWorkspace/_，开始编译Docker镜像，命名为edk2\\_dev\\_env\\_local，版本号为1.0，前方的镜像命名必须为小写，缩写含义为(EDK2\\_Development\\_Environment\\_Local)：\nsudo docker build -t edk2\\_dev\\_env\\_local:1.0 .\n\n\n1.4 启动Docker容器1.4.1 启动1.3.1中生成的edk2_dev_env:1.0镜像sudo docker run -it --name container\\_edk2\\_dev\\_env edk2\\_dev\\_env:1.0\n\n 接下来就可以正常执行uefi代码编译和开发了。\n\n1.4.2 启动1.3.2中生成的edk2_dev_env_local:1.0镜像sudo docker run -it --name container\\_edk2\\_dev\\_env\\_local edk2\\_dev\\_env\\_local:1.0\n\n\n2. 常用命令\nsudo docker ps -a                                   #显示所有正在运行和已停止的 Docker 容器的列表sudo docker rm container\\_name/id                   #删除容器(提供名称或ID)sudo docker restart container\\_name/id              #重新启动容器(提供名称或ID)sudo docker exec -it container\\_name/id /bin/bash   #以命令行的形式执行容器sudo docker images                                  #显示所有Docker镜像的列表sudo docker rmi image\\_name/id                      #删除镜像(提供名称或ID)\n","categories":["UEFI"],"tags":["UEFI"]},{"title":"[WMI] 1. Support WMI in UEFI BIOS","url":"/2024/10/11/WMI/1.%20Support%20WMI%20in%20BIOS/Support_WMI_in_BIOS/","content":"\nThis document records how to support WMI in UEFI BIOS.\n\n1. Introduce\n                            +----------------+                            |  Application   |                            +----------------+                                    ^                                    |                                    v                            +----------------+        +----------------+                            |    WMI Core    |        |                |                            |  (WmiAcpi.sys) | &lt;----&gt; |  MOF Database  |                            |   (Acpi.sys)   |        |                |                            +----------------+        +----------------+                                    ^                                    |                                    v            +--------------------------------------------------+            |             UEFI BIOS - ACPI ASL Code            |            | Device(AMW0)                                     |            | &#123;                                                |            |     Name(_HID, &quot;PNP0C14&quot;)                        |            |     Name(_UID, &quot;WmiStudy&quot;)                       |            |     Name(_WDG, Buffer() &#123;&#125;)                      |            |     // WQxx (Data Block Query)                   |            |     // WSxx (Data Block Set)                     |            |     // WMxx (Method Execution)                   |            |     // WExx (Event Enable and Disable)           |            |     // WCxx (Data Collection Enable and Disable) |            | &#125;                                                |            +--------------------------------------------------+                                    ^                                    |                                    v                    +--------------------------------+                    |  UEFI BIOS - Specific Function |                    +--------------------------------+Brief description:1. Application: Your software that is used to control WMI, like VB/C++/Python, etc.2. WMI Core: It is mainly composed by WmiAcpi.sys and Acpi.sys, Use the WmiAcpi.sys to get the MOF information under the PNP0C14 in ASL code, then report the MOF information to Acpi.sys3. UEFI BIOS - ACPI ASL Code: You need to declare &quot;PNP0C14&quot; and other code according to WMI white paper4. UEFI BIOS - Specific Function: The fucntion that is used to do for your specific things\n\n2. Porting Guid\nYou can only choose one method bewteen Method 1 and 2, can not use both method at the same time\nMethod 1: Transfer .mof to .dll and Sign up into register list\nWrite your .mof file, Below is used for reference\n//// WMI internal classes//// Define an internal event class that inherits from __ExtrinsicEventclass WMIEvent : __ExtrinsicEvent&#123;&#125;;// A method class that manipulates unsigned long integers[WMI, Dynamic, Provider(&quot;WmiProv&quot;), Locale(&quot;MS\\\\0x409&quot;), Description(&quot;Class used to operate methods on a ULong&quot;), guid(&quot;&#123;ABBC0F6F-8EA1-11d1-00A0-C90629100000&#125;&quot;)]class A_SamTest_MULong&#123;    [key, read]    string InstanceName;    [read] boolean Active;    [WmiMethodId(1),     Implemented,     read, write,     Description(&quot;Return the contents of a ULong&quot;)    ] void GetULong([out, Description(&quot;Ulong Data&quot;)] uint32 Data);    [WmiMethodId(2),     Implemented,     read, write,     Description(&quot;Set the contents of a ULong&quot;)    ] void SetULong([in, Description(&quot;Ulong Data&quot;)] uint32 Data);    [WmiMethodId(3),     Implemented,     read, write,     Description(&quot;Generate an event containing ULong data&quot;)    ] void FireULong([in, Description(&quot;WMI requires a parameter&quot;)] uint32 Hack);&#125;;\n\nOpen WmiStudy.sln by Visual Studio and compile .mof to .dll\n\nSign up .dll into register list\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\WmiAcpiMofImagePath C:\\Windows\\System32\\WmiStudy.dll # You can also put the .dll anywhere else\n\n\n\nDeclare declare “PNP0C14” into DSDT or SSDT then update the new UEFI BIOS Rom to your test mechine, Below is used for reference\nDevice(AMW0)&#123;   // PNP0C14 is PNP id assigned to WMI mapper    Name(_HID, &quot;PNP0C14&quot;)    Name(_UID, &quot;WmiStudy&quot;)     // Description of data, events and methods supported by this ASL device.    Name(_WDG, Buffer() &#123;        // ULONG        // &#123;ABBC0F6f-8EA1-11d1-00A0-C90629100000&#125;        0x6f, 0x0f, 0xBC, 0xAB, 0xa1, 0x8e, 0xd1, 0x11, 0x00, 0xa0, 0xc9, 0x06, 0x29, 0x10, 0, 0,        66, 67,        // Object Id (BC)        4,             // Instance Count        0x02,          // Flags (WMIACPI_REGFLAG_METHOD)    &#125;)    // Storage for 4 instances of ULONG    Name(SAC0, 0)    Name(SAC1, 1)    Name(SAC2, 2)    Name(SAC3, 3)    // Event Control Flag    Name(ECD2, 0)    // Get Command (SETC)    // Arg0 has the instance being queried    Method(GETC, 1)    &#123;        // Return data corresponding to instance specified        if (LEqual(Arg0, Zero)) &#123;            Return(SAC0)        &#125;        if (LEqual(Arg0, 1)) &#123;            Return(SAC1)        &#125;        if (LEqual(Arg0, 2)) &#123;            Return(SAC2)        &#125;        if (LEqual(Arg0, 3)) &#123;            Return(SAC3)        &#125;    &#125;    // Set Command (SETC)    // Arg0 has the instance being queried    // Arg1 has the data passed    Method(SETC, 2)    &#123;        // Return data corresponding to instance specified        if (LEqual(Arg0, Zero)) &#123;            Store(Arg1, SAC0)            Return(SAC0)        &#125;        if (LEqual(Arg0, 1)) &#123;            Store(Arg1, SAC1)            Return(SAC1)        &#125;        if (LEqual(Arg0, 2)) &#123;            Store(Arg1, SAC2)            Return(SAC2)        &#125;        if (LEqual(Arg0, 3)) &#123;            Store(Arg1, SAC3)            Return(SAC3)        &#125;    &#125;    // Validate Instance (VINS)    // Validate that instance index is between 0 and 3    // Arg0 has the instance being queried    Method(VINS, 1)    &#123;        if (LLess(Arg0, Zero))        &#123;            Name(Foo, &quot;WMIACPI: ASL: VINS called with InstanceIndex = &quot;)            Store(Foo, Debug)            Store(Arg0, Debug)            Fatal(0xa0, 27, 0)        &#125;        if (LGreater(Arg0, 3))        &#123;            Name(Foo1, &quot;WMIACPI: ASL: VINS called with InstanceIndex = &quot;)            Store(Foo1, Debug)            Store(Arg0, Debug)            Fatal(0xa0, 28, 0)        &#125;    &#125;    // WMI Method &#x27;BC&#x27; (WMBC)    // ULONG Method data block    // Arg0 has the instance being queried    // Arg1 has the method id    // Arg2 has the data passed    Method(WMBC, 3) &#123;        // MethodId 1 - Get        if (LEqual(Arg1, 1))        &#123;            Return(GETC(Arg0))        &#125;        // MethodId 2 - Set        if (LEqual(Arg1, 2))        &#123;            SETC(Arg0, Arg2)            Store(0x01, ECD2)            Return(0)        &#125;        // MethodId 3 - Event Generate        if (LEqual(Arg1, 3))        &#123;            VINS(Arg0)            if (LEqual(ECD2, Zero))            &#123;                // ERROR - Event Control was not enabled                Name(Foo, &quot;WMIACPI: ASL: WMBC called, but ECD2 is 0\\n&quot;)                Store(Foo, Debug)                Fatal(0xa0, 31, 0)            &#125;            Notify(AMW0, 0xd2)            Store(0x00, ECD2)            Return(0)        &#125;    &#125;&#125;\n\nMethod 2: Transfer .mof to .x and save the value of .x into ASL CODE\nWrite your .mof file, Below is used for reference\n//// WMI internal classes//// Define an internal event class that inherits from __ExtrinsicEventclass WMIEvent : __ExtrinsicEvent&#123;&#125;;// A method class that manipulates unsigned long integers[WMI, Dynamic, Provider(&quot;WmiProv&quot;), Locale(&quot;MS\\\\0x409&quot;), Description(&quot;Class used to operate methods on a ULong&quot;), guid(&quot;&#123;ABBC0F6F-8EA1-11d1-00A0-C90629100000&#125;&quot;)]class A_SamTest_MULong&#123;    [key, read]    string InstanceName;    [read] boolean Active;    [WmiMethodId(1),     Implemented,     read, write,     Description(&quot;Return the contents of a ULong&quot;)    ] void GetULong([out, Description(&quot;Ulong Data&quot;)] uint32 Data);    [WmiMethodId(2),     Implemented,     read, write,     Description(&quot;Set the contents of a ULong&quot;)    ] void SetULong([in, Description(&quot;Ulong Data&quot;)] uint32 Data);    [WmiMethodId(3),     Implemented,     read, write,     Description(&quot;Generate an event containing ULong data&quot;)    ] void FireULong([in, Description(&quot;WMI requires a parameter&quot;)] uint32 Hack);&#125;;\n\nCompile .mof to .bmf in CMD\n\n\n.\\mofcomp.exe -WMI -B:WmiStudy.bmf WmiStudy.mof\n\n\nCompile .bmf to .x in CMD\n\n.\\wmimofck.exe -xWmiStudy.x WmiStudy.bmf\n\n\nDeclare “PNP0C14”, Copy the value in the .x to Name(WQBA, Buffer()) in the asl code into DSDT or SSDT then update the new UEFI BIOS Rom to your test mechine, Below is used for reference\n\nDevice(AMW0)&#123;   // PNP0C14 is PNP id assigned to WMI mapper    Name(_HID, &quot;PNP0C14&quot;)    Name(_UID, &quot;WmiStudy&quot;)     // Description of data, events and methods supported by this ASL device.    Name(_WDG, Buffer() &#123;        // ULONG        // &#123;ABBC0F6f-8EA1-11d1-00A0-C90629100000&#125;        0x6f, 0x0f, 0xBC, 0xAB, 0xa1, 0x8e, 0xd1, 0x11, 0x00, 0xa0, 0xc9, 0x06, 0x29, 0x10, 0, 0,        66, 67,        // Object Id (BC)        4,             // Instance Count        0x02,          // Flags (WMIACPI_REGFLAG_METHOD)        // This GUID for returning the MOF data        0x21, 0x12, 0x90, 0x05, 0x66, 0xd5, 0xd1, 0x11, 0xb2, 0xf0, 0x00, 0xa0, 0xc9, 0x06, 0x29, 0x10,        66, 65,        // Object ID (BA)        1,             // Instance Count        0x00,          // Flags    &#125;)    // Storage for 4 instances of ULONG    Name(SAC0, 0)    Name(SAC1, 1)    Name(SAC2, 2)    Name(SAC3, 3)    // Event Control Flag    Name(ECD2, 0)    // Get Command (SETC)    // Arg0 has the instance being queried    Method(GETC, 1)    &#123;        // Return data corresponding to instance specified        if (LEqual(Arg0, Zero)) &#123;            Return(SAC0)        &#125;        if (LEqual(Arg0, 1)) &#123;            Return(SAC1)        &#125;        if (LEqual(Arg0, 2)) &#123;            Return(SAC2)        &#125;        if (LEqual(Arg0, 3)) &#123;            Return(SAC3)        &#125;    &#125;    // Set Command (SETC)    // Arg0 has the instance being queried    // Arg1 has the data passed    Method(SETC, 2)    &#123;        // Return data corresponding to instance specified        if (LEqual(Arg0, Zero)) &#123;            Store(Arg1, SAC0)            Return(SAC0)        &#125;        if (LEqual(Arg0, 1)) &#123;            Store(Arg1, SAC1)            Return(SAC1)        &#125;        if (LEqual(Arg0, 2)) &#123;            Store(Arg1, SAC2)            Return(SAC2)        &#125;        if (LEqual(Arg0, 3)) &#123;            Store(Arg1, SAC3)            Return(SAC3)        &#125;    &#125;    // Validate Instance (VINS)    // Validate that instance index is between 0 and 3    // Arg0 has the instance being queried    Method(VINS, 1)    &#123;        if (LLess(Arg0, Zero))        &#123;            Name(Foo, &quot;WMIACPI: ASL: VINS called with InstanceIndex = &quot;)            Store(Foo, Debug)            Store(Arg0, Debug)            Fatal(0xa0, 27, 0)        &#125;        if (LGreater(Arg0, 3))        &#123;            Name(Foo1, &quot;WMIACPI: ASL: VINS called with InstanceIndex = &quot;)            Store(Foo1, Debug)            Store(Arg0, Debug)            Fatal(0xa0, 28, 0)        &#125;    &#125;    // WMI Method &#x27;BC&#x27; (WMBC)    // ULONG Method data block    // Arg0 has the instance being queried    // Arg1 has the method id    // Arg2 has the data passed    Method(WMBC, 3) &#123;        // MethodId 1 - Get        if (LEqual(Arg1, 1))        &#123;            Return(GETC(Arg0))        &#125;        // MethodId 2 - Set        if (LEqual(Arg1, 2))        &#123;            SETC(Arg0, Arg2)            Store(0x01, ECD2)            Return(0)        &#125;        // MethodId 3 - Event Generate        if (LEqual(Arg1, 3))        &#123;            VINS(Arg0)            if (LEqual(ECD2, Zero))            &#123;                // ERROR - Event Control was not enabled                Name(Foo, &quot;WMIACPI: ASL: WMBC called, but ECD2 is 0\\n&quot;)                Store(Foo, Debug)                Fatal(0xa0, 31, 0)            &#125;            Notify(AMW0, 0xd2)            Store(0x00, ECD2)            Return(0)        &#125;    &#125;    Name(WQBA, Buffer() &#123;        0x46, 0x4f, 0x4d, 0x42, 0x01, 0x00, 0x00, 0x00, 0xaf, 0x03, 0x00, 0x00, 0x54, 0x0c, 0x00, 0x00,        0x44, 0x53, 0x00, 0x01, 0x1a, 0x7d, 0xda, 0x54, 0x28, 0x40, 0x86, 0x00, 0x01, 0x06, 0x18, 0x42,        0x10, 0x05, 0x10, 0x22, 0x21, 0x04, 0x12, 0x01, 0xa1, 0xc8, 0x2c, 0x0c, 0x86, 0x10, 0x38, 0x2e,        0x84, 0x1c, 0x40, 0x48, 0x1c, 0x14, 0x4a, 0x08, 0x84, 0xfa, 0x13, 0xc8, 0xaf, 0x00, 0x84, 0x0e,        0x05, 0xc8, 0x14, 0x60, 0x50, 0x80, 0x53, 0x04, 0x11, 0xf4, 0x2a, 0xc0, 0xa6, 0x00, 0x93, 0x02,        0x2c, 0x0a, 0xd0, 0x2e, 0xc0, 0xb2, 0x00, 0xdd, 0x02, 0xa4, 0xc3, 0x12, 0x91, 0xe0, 0x28, 0x31,        0xe0, 0x28, 0x9d, 0xd8, 0xc2, 0x0d, 0x1b, 0xbc, 0x50, 0x14, 0xcd, 0x20, 0x4a, 0x82, 0xca, 0x05,        0xf8, 0x46, 0x10, 0x78, 0xb9, 0x02, 0x24, 0x4f, 0x40, 0x9a, 0x05, 0x18, 0x16, 0x60, 0x5d, 0x80,        0xec, 0x21, 0x50, 0xa9, 0x43, 0x40, 0xc9, 0x19, 0x02, 0x6a, 0x00, 0xad, 0x4e, 0x40, 0xf8, 0x95,        0x4e, 0x09, 0x49, 0x10, 0xce, 0x58, 0xc5, 0xe3, 0x6b, 0x16, 0x4d, 0xcf, 0x49, 0xce, 0x31, 0xe4,        0x78, 0x5c, 0xe8, 0x41, 0xf0, 0xd8, 0x2a, 0x40, 0x58, 0x98, 0x21, 0x4b, 0xe8, 0x5a, 0x0d, 0x43,        0x35, 0x8c, 0x85, 0xba, 0x18, 0x35, 0x6a, 0xa4, 0x6c, 0x40, 0x86, 0x28, 0x09, 0x0e, 0x35, 0x6a,        0x4b, 0x14, 0x60, 0x7e, 0x1c, 0x9a, 0x5d, 0xdb, 0x63, 0x21, 0x90, 0x4c, 0xda, 0x50, 0x50, 0x52,        0x20, 0x34, 0xb6, 0x33, 0xf5, 0x8c, 0x22, 0x1e, 0xa9, 0x61, 0x12, 0x78, 0x14, 0x91, 0x8d, 0xc6,        0xa1, 0xb1, 0xc3, 0xf0, 0x30, 0x83, 0x1d, 0xc4, 0x61, 0x1c, 0x73, 0xe4, 0x04, 0x9e, 0xd0, 0x91,        0x1e, 0x79, 0x61, 0xf3, 0x14, 0x6a, 0x8c, 0xe6, 0xa0, 0x88, 0xfc, 0xa3, 0x00, 0x7a, 0x4c, 0x61,        0x8f, 0x36, 0xf6, 0xf9, 0x5a, 0xf8, 0x60, 0x85, 0x71, 0x04, 0xc7, 0x95, 0xe0, 0xff, 0x7f, 0xe6,        0x67, 0x70, 0x0a, 0xd1, 0x22, 0x14, 0x74, 0x0f, 0x10, 0x46, 0xcc, 0x43, 0x8a, 0x12, 0x30, 0x5e,        0x8c, 0x10, 0x51, 0x8f, 0xca, 0x80, 0x81, 0x82, 0x04, 0x3a, 0xab, 0x18, 0x51, 0x8a, 0x06, 0x13,        0x64, 0x60, 0x4f, 0xc0, 0x18, 0xf1, 0x42, 0x3c, 0x0d, 0x1c, 0x95, 0x71, 0x7a, 0x1e, 0x0c, 0x99,        0xc4, 0xf1, 0x60, 0xbe, 0x11, 0xc2, 0xd2, 0x34, 0x0e, 0xd4, 0x04, 0x76, 0x7f, 0x2a, 0xd0, 0x63,        0x22, 0xc2, 0xe1, 0x9c, 0x5a, 0x8d, 0x02, 0xb4, 0x41, 0xc8, 0xd6, 0x19, 0x42, 0x47, 0x82, 0x58,        0x8d, 0xa1, 0x08, 0x22, 0x42, 0xd0, 0x28, 0xc6, 0x8b, 0x10, 0x2a, 0x44, 0x94, 0xa8, 0x27, 0x19,        0x24, 0x6a, 0x65, 0x20, 0x42, 0x0b, 0x66, 0x04, 0x66, 0x7f, 0x10, 0x24, 0xdc, 0xb1, 0x40, 0x12,        0x40, 0x14, 0x69, 0x34, 0xa8, 0x33, 0x83, 0x8f, 0x06, 0x3e, 0x16, 0x3c, 0x2a, 0x78, 0x72, 0x27,        0x16, 0xe4, 0x74, 0x8f, 0xef, 0x49, 0xe2, 0x99, 0xc0, 0xa3, 0x67, 0x97, 0x05, 0x7f, 0x13, 0x7c,        0x48, 0xc0, 0xbb, 0x06, 0xd4, 0xed, 0xe0, 0xd9, 0x80, 0x0d, 0x33, 0x1c, 0x66, 0x88, 0x9e, 0x72,        0xb8, 0x13, 0x38, 0x44, 0x06, 0xe8, 0x11, 0x3d, 0x16, 0x60, 0xa7, 0x76, 0x32, 0xcf, 0x04, 0xaf,        0x15, 0xcd, 0x5e, 0x28, 0x08, 0xc1, 0xf1, 0xf8, 0x2e, 0xc1, 0x86, 0xcd, 0x4e, 0x05, 0x1e, 0x04,        0x1f, 0x99, 0xa1, 0x3d, 0xd2, 0xd3, 0x7a, 0x27, 0xf0, 0x91, 0xc2, 0x04, 0x16, 0x7b, 0x22, 0xa1,        0xe3, 0x01, 0xbf, 0xe2, 0xf3, 0x07, 0xb9, 0x38, 0x78, 0xbe, 0x3e, 0x8e, 0x60, 0x0f, 0x27, 0xb8,        0xff, 0xff, 0xcd, 0x03, 0x07, 0xf2, 0x00, 0xe2, 0x91, 0x7b, 0x08, 0xef, 0x0e, 0x1e, 0x56, 0xa0,        0xa3, 0x78, 0x4e, 0xc0, 0x1e, 0x50, 0x80, 0x47, 0x08, 0x0f, 0x07, 0x02, 0x26, 0x7d, 0xad, 0xb2,        0xb1, 0x56, 0x1f, 0x3a, 0xa8, 0xd8, 0x43, 0x82, 0x3c, 0x1e, 0x25, 0xc8, 0x70, 0xb0, 0x12, 0xc1,        0x74, 0xb2, 0xe1, 0xe2, 0x28, 0x24, 0x0d, 0x42, 0xe3, 0xf1, 0x90, 0x08, 0x1c, 0x05, 0xf1, 0xf8,        0x1d, 0x14, 0x42, 0x4e, 0x8e, 0x02, 0xa8, 0x03, 0x80, 0x0f, 0x1c, 0x6f, 0x18, 0x86, 0x48, 0xe0,        0x60, 0x10, 0x3a, 0x3d, 0xf8, 0xbc, 0x80, 0x9f, 0xcb, 0x81, 0x9d, 0x97, 0x67, 0x61, 0x81, 0x07,        0x10, 0xd0, 0xcc, 0xec, 0x24, 0xcf, 0x8c, 0xad, 0xf0, 0x48, 0x70, 0xe3, 0xf0, 0xf7, 0x85, 0x0e,        0x81, 0xdc, 0x0b, 0xe2, 0x25, 0xe0, 0xe7, 0x03, 0xf8, 0x77, 0x0f, 0x9f, 0x6a, 0xec, 0xec, 0xb4,        0x21, 0x02, 0x8f, 0x09, 0x77, 0x3e, 0x80, 0x07, 0xe4, 0xeb, 0x80, 0x8f, 0x3b, 0x8f, 0x04, 0x6c,        0x0e, 0x4f, 0x3c, 0x3e, 0xef, 0x30, 0x78, 0x2e, 0x62, 0xe0, 0xb2, 0x00, 0x22, 0x59, 0xe3, 0x42,        0xfd, 0xff, 0xc7, 0xe9, 0xc3, 0x0c, 0xc3, 0x7e, 0x4f, 0xc1, 0x0c, 0xea, 0x55, 0xc2, 0xa7, 0x00,        0xc3, 0x7a, 0xe4, 0x1c, 0xd6, 0x68, 0x61, 0x0f, 0xf8, 0x31, 0xc2, 0x57, 0x10, 0xcf, 0xcc, 0x97,        0x17, 0x1f, 0x3e, 0xc0, 0x02, 0x88, 0xf7, 0x7e, 0x07, 0x20, 0x13, 0x30, 0x20, 0x1b, 0xcf, 0xd3,        0x00, 0x58, 0x86, 0x79, 0x6a, 0x9e, 0x79, 0xb0, 0x07, 0x1a, 0x8f, 0xce, 0xf7, 0x1a, 0x83, 0xc6,        0xf3, 0x1c, 0x8c, 0xe1, 0x83, 0x0d, 0x3b, 0x4d, 0x3c, 0xd8, 0x40, 0x3a, 0x4d, 0x40, 0x99, 0xfa,        0xd3, 0x04, 0xb0, 0xbe, 0x2a, 0x78, 0xe0, 0xfc, 0x34, 0x01, 0x9c, 0xff, 0xff, 0xa7, 0x09, 0xe0,        0xb7, 0x72, 0x9f, 0x26, 0xc0, 0x75, 0x06, 0xf0, 0x69, 0x02, 0xb8, 0x0a, 0x3e, 0x0d, 0x80, 0xe6,        0xe0, 0xc0, 0xee, 0x12, 0x60, 0x0c, 0x74, 0x96, 0x40, 0x4b, 0x1f, 0xb4, 0x4e, 0x5b, 0x67, 0x71,        0x68, 0x06, 0xc5, 0x09, 0x3e, 0x4b, 0xa0, 0xa4, 0x1e, 0xe7, 0x7c, 0x96, 0x40, 0x1d, 0x27, 0x0c,        0x66, 0x10, 0x0f, 0xdc, 0xb1, 0xcf, 0x12, 0x50, 0x8e, 0x45, 0xa7, 0x73, 0x54, 0xef, 0x57, 0x09,        0x1c, 0xf3, 0x2c, 0x01, 0x8a, 0x53, 0x51, 0x28, 0xf6, 0xff, 0x1f, 0x2e, 0xfc, 0x83, 0x1e, 0x5b,        0xe0, 0xc1, 0xd9, 0xf8, 0xcd, 0x81, 0xa0, 0x78, 0xb0, 0x9e, 0xaa, 0x51, 0x63, 0x3c, 0xb8, 0xf9,        0xda, 0xc6, 0x0e, 0x78, 0xfc, 0x48, 0x01, 0x38, 0x39, 0x9a, 0xf8, 0x48, 0x01, 0x2e, 0x48, 0x1f,        0x29, 0x80, 0xeb, 0xf9, 0xf0, 0xa1, 0x00, 0x2c, 0xe7, 0x2e, 0x83, 0xbc, 0x15, 0xe2, 0x0e, 0x6a,        0xc6, 0x88, 0xf2, 0x8a, 0xc9, 0xcf, 0x15, 0x18, 0xb4, 0x67, 0x00, 0x1f, 0xe8, 0xd8, 0xad, 0x02,        0x07, 0x73, 0x58, 0x6f, 0x2f, 0xfc, 0xff, 0xaf, 0xd0, 0xa6, 0x4f, 0x8d, 0x46, 0xad, 0x1a, 0x94,        0xa9, 0x51, 0xa6, 0x41, 0xad, 0x3e, 0x95, 0x1a, 0x33, 0x36, 0x22, 0xcb, 0x5b, 0xaf, 0x06, 0xec,        0x70, 0x20, 0x54, 0xec, 0xf2, 0x65, 0xe4, 0x7c, 0x61, 0x10, 0x01, 0x39, 0xe6, 0xf9, 0x4c, 0x40,        0x0e, 0x7d, 0x42, 0xa3, 0x52, 0x0f, 0x9f, 0x02, 0xb2, 0x70, 0x10, 0x01, 0xf9, 0xff, 0x0f    &#125;)&#125;\n\n3. Debug\nReboot your test mechine if you finished part 2\n\nOpen WMICodeCreator.exe, you will see the class: A_SamTest_MULong under Namespace: root\\WMI in the bar: Query for data from a WMI class, you can debug under the bar: Execute a method or use Visual studio to open projects in the Application\\A_SamTest_MULong(Corresponds to the method 1 or 2 you are using)      \n\nIf your WMI class does not appear in WMICodeCreator.exe, please follow the steps below in CMD, then reboot your test mechine\n  1. net stop winmgmt                     # stop WMI service2. winmgmt /salvagerepository           # clean WMI repository# if command 2 execution  failed, please retry command 3# 3. cd %windir%\\System32\\wbem# 3. rd /S /Q repository4. net start winmgmt                    # start WMI service5. for %i in (*.dll) do regsvr32 /s %i  # Re-register for the WMI service\n\nReference\n1. Windows Management Instrumentation\n2. Windows Instrumentation: WMI and ACPI\n3. Building and Deploying the Localized MOF File\n4. Implementing Dynamic MOF Data\n5. Compiling a Driver’s MOF File\n6. Using Wmimofck.exe\n\n","categories":["WMI"],"tags":["WMI"]},{"title":"[Windbg] Use windbg for dual-machine debugging","url":"/2024/09/19/Windbg/Dual_machine_network_commissioning/Dual_machine_network_commissioning/","content":"\nThis topic is used to record How to use windbg for dual-machine debugging.\n\n\nHost ip: 192.168.77.10\nClient ip: 192.168.77.35\n\n\n\nSet on client machine\n\n# 1. Execute the following command in CMD:bcdedit /set testsigning on        # Turn on Windows Test Modebcdedit /debug on                  # Enable kernel debugging for the Windows operating system associated with a specified startup item or the current startup itembcdedit /bootdebug on              # Enable startup debugging for the current or specified Windows operating system startup itemsbcdedit /set nointegritychecks on  # Enable digital signatures permanently# 2. Configure the debugging startup parameters of the target machinebcdedit /dbgsettings net hostip:192.168.77.10 port:50000 key:abcd1234.abcd1234.abcd1234.abcd1234# 3. Allow port 50000netsh advfirewall firewall add rule name=&quot;Windbg Debug&quot; dir=in action=allow protocol=TCP localport=50000# 4. Reboot client machineshutdown /r /t 0\n\n\nSet on host machine\n\n1. Open Windbg, select File &gt; Kernel Debug2. In the dialog box that pops up, select the NET tab3. In the Port field, enter the port number 50000 that you set on the target machine4. Enter the key you set in the Key field, abcd1234.abcd1234.abcd1234.abcd12345. Enter the IP address of the target machine in the Target IP field, 192.168.77.356. Adjust the printing level of debug messages, ed nt!Kd_DEFAULT_Mask 0xFFFFFFFF\n","categories":["Windbg"],"tags":["Windbg"]},{"title":"[Windbg] Blue screen debug method","url":"/2025/06/11/Windbg/Blue_screen_debug_method/Blue_screen_debug_method/","content":"\nThis topic is used to record How to use windbg for KMDF Driver blue screen debug based on the Analysis of Dump File.\n\n1. Grab the blue screen log\nFind out the blue screen log under this location C:\\WINDOWS\\Minidumpsuch as 061125-28265-01.dmp\n\n2. Debug with Windbg2.1 Load the log\nOpen Windbg, select File &gt; Open Crash Dump\nWait for loading\n\nMicrosoft (R) Windows Debugger Version 10.0.19041.685 AMD64Copyright (c) Microsoft Corporation. All rights reserved.Loading Dump File [C:\\Users\\Administrator\\Desktop\\WDF_error\\061125-28937-01.dmp]Mini Kernel Dump File: Only registers and stack trace are availableSymbol search path is: srv*Executable search path is: Windows 10 Kernel Version 26100 MP (24 procs) Free x64Product: WinNt, suite: TerminalServer SingleUserTSMachine Name:Kernel base = 0xfffff804`bfa00000 PsLoadedModuleList = 0xfffff804`c08f4aa0Debug session time: Wed Jun 11 14:37:42.041 2025 (UTC + 8:00)System Uptime: 0 days 0:05:25.322Loading Kernel Symbols......................................................................................................................................................................................................Loading User SymbolsLoading unloaded module list............For analysis of this file, run !analyze -v\n\n\nEnter the analysis command !analyze -v\n\n23: kd&gt; !analyze -v********************************************************************************                                                                             **                        Bugcheck Analysis                                    **                                                                             ********************************************************************************WDF_VIOLATION (10d)The Kernel-Mode Driver Framework was notified that Windows detected an errorin a framework-based driver. In general, the dump file will yield additionalinformation about the driver that caused this bug check.Arguments:Arg1: 0000000000000005, A framework object handle of the incorrect type was passed to\ta framework object method.Arg2: 0000000000000000, The handle value passed in.Arg3: 0000000000001201, Reserved.Arg4: ffffc6011d35ddd0, Reserved.Debugging Details:------------------*** WARNING: Unable to verify timestamp for StcMcuI2cDriver.sysKEY_VALUES_STRING: 1    Key  : Analysis.CPU.Sec    Value: 0    Key  : Analysis.DebugAnalysisProvider.CPP    Value: Create: 8007007e on SAM-DIAO    Key  : Analysis.DebugData    Value: CreateObject    Key  : Analysis.DebugModel    Value: CreateObject    Key  : Analysis.Elapsed.Sec    Value: 2    Key  : Analysis.Memory.CommitPeak.Mb    Value: 119    Key  : Analysis.System    Value: CreateObjectTAG_NOT_DEFINED_202b:  *** Unknown TAG in analysis list 202bDUMP_FILE_ATTRIBUTES: 0x21808  Kernel Generated Triage DumpBUGCHECK_CODE:  10dBUGCHECK_P1: 5BUGCHECK_P2: 0BUGCHECK_P3: 1201BUGCHECK_P4: ffffc6011d35ddd0BLACKBOXBSD: 1 (!blackboxbsd)BLACKBOXNTFS: 1 (!blackboxntfs)BLACKBOXPNP: 1 (!blackboxpnp)BLACKBOXWINLOGON: 1CUSTOMER_CRASH_COUNT:  1PROCESS_NAME:  MaxsunSyncServSTACK_TEXT:  ffff828a`3e186ea8 fffff804`520d30dc : 00000000`0000010d 00000000`00000005 00000000`00000000 00000000`00001201 : nt!KeBugCheckExffff828a`3e186eb0 fffff804`520612f8 : ffffc601`1eba7c00 ffffc601`1d35ddd0 00000000`00000000 000039fe`db480201 : Wdf01000!FxVerifierBugCheckWorker+0x24 [minkernel\\wdf\\framework\\shared\\object\\fxverifierbugcheck.cpp @ 87] ffff828a`3e186ef0 fffff804`68f02d67 : ffffc601`1d13dba0 ffffc601`1eba7c00 fffff804`68f07050 00000000`04001c04 : Wdf01000!imp_WdfIoTargetClose+0x118 [minkernel\\wdf\\framework\\shared\\targets\\general\\fxiotargetapi.cpp @ 620] ffff828a`3e186f60 ffffc601`1d13dba0 : ffffc601`1eba7c00 fffff804`68f07050 00000000`04001c04 ffffc601`1d35ddd0 : StcMcuI2cDriver+0x2d67ffff828a`3e186f68 ffffc601`1eba7c00 : fffff804`68f07050 00000000`04001c04 ffffc601`1d35ddd0 fffff804`68f0223f : 0xffffc601`1d13dba0ffff828a`3e186f70 fffff804`68f07050 : 00000000`04001c04 ffffc601`1d35ddd0 fffff804`68f0223f 000039fe`db4802d8 : 0xffffc601`1eba7c00ffff828a`3e186f78 00000000`04001c04 : ffffc601`1d35ddd0 fffff804`68f0223f 000039fe`db4802d8 ffffc601`1d8a36c0 : StcMcuI2cDriver+0x7050ffff828a`3e186f80 ffffc601`1d35ddd0 : fffff804`68f0223f 000039fe`db4802d8 ffffc601`1d8a36c0 000039fe`e275c938 : 0x4001c04ffff828a`3e186f88 fffff804`68f0223f : 000039fe`db4802d8 ffffc601`1d8a36c0 000039fe`e275c938 000039fe`db4802d8 : 0xffffc601`1d35ddd0ffff828a`3e186f90 000039fe`db4802d8 : ffffc601`1d8a36c0 000039fe`e275c938 000039fe`db4802d8 ffffc601`1d8a36c0 : StcMcuI2cDriver+0x223fffff828a`3e186f98 ffffc601`1d8a36c0 : 000039fe`e275c938 000039fe`db4802d8 ffffc601`1d8a36c0 ffffc601`1d8a3730 : 0x000039fe`db4802d8ffff828a`3e186fa0 000039fe`e275c938 : 000039fe`db4802d8 ffffc601`1d8a36c0 ffffc601`1d8a3730 00000000`04001c04 : 0xffffc601`1d8a36c0ffff828a`3e186fa8 000039fe`db4802d8 : ffffc601`1d8a36c0 ffffc601`1d8a3730 00000000`04001c04 fffff804`5205fde6 : 0x000039fe`e275c938ffff828a`3e186fb0 ffffc601`1d8a36c0 : ffffc601`1d8a3730 00000000`04001c04 fffff804`5205fde6 ffffc601`24b7fd20 : 0x000039fe`db4802d8ffff828a`3e186fb8 ffffc601`1d8a3730 : 00000000`04001c04 fffff804`5205fde6 ffffc601`24b7fd20 ffffc601`1d8a3890 : 0xffffc601`1d8a36c0ffff828a`3e186fc0 00000000`04001c04 : fffff804`5205fde6 ffffc601`24b7fd20 ffffc601`1d8a3890 000039fe`e275c938 : 0xffffc601`1d8a3730ffff828a`3e186fc8 fffff804`5205fde6 : ffffc601`24b7fd20 ffffc601`1d8a3890 000039fe`e275c938 00000000`00000000 : 0x4001c04ffff828a`3e186fd0 fffff804`5205eae9 : 00000000`00000000 fffff804`52104c28 00000000`0000000b ffffc601`1d8a36c0 : Wdf01000!FxIoQueue::DispatchRequestToDriver+0x296 [minkernel\\wdf\\framework\\shared\\irphandlers\\io\\fxioqueue.cpp @ 3448] ffff828a`3e187050 fffff804`5205b173 : ffffc601`1d8a36c0 fffff804`bfcf4c00 00000000`00000000 ffffc601`24b7fd20 : Wdf01000!FxIoQueue::DispatchEvents+0xa99 [minkernel\\wdf\\framework\\shared\\irphandlers\\io\\fxioqueue.cpp @ 3125] ffff828a`3e187160 fffff804`68f02ad1 : 000039fe`db480200 000039fe`e276d688 fffff804`68f07000 ffffc601`00000001 : Wdf01000!imp_WdfRequestForwardToIoQueue+0x343 [minkernel\\wdf\\framework\\shared\\core\\fxrequestapi.cpp @ 3130] ffff828a`3e187230 000039fe`db480200 : 000039fe`e276d688 fffff804`68f07000 ffffc601`00000001 ffffc601`24b7fd20 : StcMcuI2cDriver+0x2ad1ffff828a`3e187238 000039fe`e276d688 : fffff804`68f07000 ffffc601`00000001 ffffc601`24b7fd20 00000000`00000000 : 0x000039fe`db480200ffff828a`3e187240 fffff804`68f07000 : ffffc601`00000001 ffffc601`24b7fd20 00000000`00000000 0000000e`00000028 : 0x000039fe`e276d688ffff828a`3e187248 ffffc601`00000001 : ffffc601`24b7fd20 00000000`00000000 0000000e`00000028 00000000`00000000 : StcMcuI2cDriver+0x7000ffff828a`3e187250 ffffc601`24b7fd20 : 00000000`00000000 0000000e`00000028 00000000`00000000 00000000`00000000 : 0xffffc601`00000001ffff828a`3e187258 00000000`00000000 : 0000000e`00000028 00000000`00000000 00000000`00000000 00000000`04001c04 : 0xffffc601`24b7fd20SYMBOL_NAME:  StcMcuI2cDriver+2d67MODULE_NAME: StcMcuI2cDriverIMAGE_NAME:  StcMcuI2cDriver.sysSTACK_COMMAND:  .thread ; .cxr ; kbBUCKET_ID_FUNC_OFFSET:  2d67FAILURE_BUCKET_ID:  0x10D_5_StcMcuI2cDriver!unknown_functionOSPLATFORM_TYPE:  x64OSNAME:  Windows 10FAILURE_ID_HASH:  &#123;f601315d-5c7a-bc38-1801-2c856e4bfc93&#125;Followup:     MachineOwner---------\n\n\nSpecify the path to the .sys and .pdb (usually these two together)\n\n23: kd&gt; .sympath+ C:\\Users\\Administrator\\Desktop\\WDF_error\\1\\1.2\\sys\\x64\\ReleaseSymbol search path is: srv*;C:\\Users\\Administrator\\Desktop\\WDF_error\\1\\1.2\\sys\\x64\\ReleaseExpanded Symbol search path is: cache*;SRV*https://msdl.microsoft.com/download/symbols;c:\\users\\administrator\\desktop\\wdf_error\\1\\1.2\\sys\\x64\\release************* Path validation summary **************Response                         Time (ms)     LocationDeferred                                       srv*OK                                             C:\\Users\\Administrator\\Desktop\\WDF_error\\1\\1.2\\sys\\x64\\Release\n\n\nLoad your driver(.sys)\n\n23: kd&gt; .reload /f StcMcuI2cDriver.sys\n\n\nEnter the analysis command !analyze -v again\n\nThis time, you can see the specific code location of the error\n\n\n\n23: kd&gt; !analyze -v********************************************************************************                                                                             **                        Bugcheck Analysis                                    **                                                                             ********************************************************************************WDF_VIOLATION (10d)The Kernel-Mode Driver Framework was notified that Windows detected an errorin a framework-based driver. In general, the dump file will yield additionalinformation about the driver that caused this bug check.Arguments:Arg1: 0000000000000005, A framework object handle of the incorrect type was passed to\ta framework object method.Arg2: 0000000000000000, The handle value passed in.Arg3: 0000000000001201, Reserved.Arg4: ffffc6011d35ddd0, Reserved.Debugging Details:------------------KEY_VALUES_STRING: 1    Key  : Analysis.CPU.Sec    Value: 0    Key  : Analysis.DebugAnalysisProvider.CPP    Value: Create: 8007007e on SAM-DIAO    Key  : Analysis.DebugData    Value: CreateObject    Key  : Analysis.DebugModel    Value: CreateObject    Key  : Analysis.Elapsed.Sec    Value: 0    Key  : Analysis.Memory.CommitPeak.Mb    Value: 131    Key  : Analysis.System    Value: CreateObjectTAG_NOT_DEFINED_202b:  *** Unknown TAG in analysis list 202bDUMP_FILE_ATTRIBUTES: 0x21808  Kernel Generated Triage DumpBUGCHECK_CODE:  10dBUGCHECK_P1: 5BUGCHECK_P2: 0BUGCHECK_P3: 1201BUGCHECK_P4: ffffc6011d35ddd0BLACKBOXBSD: 1 (!blackboxbsd)BLACKBOXNTFS: 1 (!blackboxntfs)BLACKBOXPNP: 1 (!blackboxpnp)BLACKBOXWINLOGON: 1CUSTOMER_CRASH_COUNT:  1PROCESS_NAME:  MaxsunSyncServSTACK_TEXT:  ffff828a`3e186ea8 fffff804`520d30dc : 00000000`0000010d 00000000`00000005 00000000`00000000 00000000`00001201 : nt!KeBugCheckExffff828a`3e186eb0 fffff804`520612f8 : ffffc601`1eba7c00 ffffc601`1d35ddd0 00000000`00000000 000039fe`db480201 : Wdf01000!FxVerifierBugCheckWorker+0x24 [minkernel\\wdf\\framework\\shared\\object\\fxverifierbugcheck.cpp @ 87] ffff828a`3e186ef0 fffff804`68f02d67 : ffffc601`1d13dba0 ffffc601`1eba7c00 fffff804`68f07050 00000000`04001c04 : Wdf01000!imp_WdfIoTargetClose+0x118 [minkernel\\wdf\\framework\\shared\\targets\\general\\fxiotargetapi.cpp @ 620] ffff828a`3e186f60 fffff804`68f0223f : 000039fe`db4802d8 ffffc601`1d8a36c0 000039fe`e275c938 000039fe`db4802d8 : StcMcuI2cDriver!SpbPeripheralClose+0x8f [D:\\Project\\Drivers\\Windows\\SourceCode\\Pch_I2C\\Source\\1.2\\sys\\peripheral.cpp @ 129] ffff828a`3e186f90 fffff804`5205fde6 : ffffc601`24b7fd20 ffffc601`1d8a3890 000039fe`e275c938 00000000`00000000 : StcMcuI2cDriver!OnIoDeviceControl+0x1cf [D:\\Project\\Drivers\\Windows\\SourceCode\\Pch_I2C\\Source\\1.2\\sys\\device.cpp @ 706] ffff828a`3e186fd0 fffff804`5205eae9 : 00000000`00000000 fffff804`52104c28 00000000`0000000b ffffc601`1d8a36c0 : Wdf01000!FxIoQueue::DispatchRequestToDriver+0x296 [minkernel\\wdf\\framework\\shared\\irphandlers\\io\\fxioqueue.cpp @ 3448] ffff828a`3e187050 fffff804`5205b173 : ffffc601`1d8a36c0 fffff804`bfcf4c00 00000000`00000000 ffffc601`24b7fd20 : Wdf01000!FxIoQueue::DispatchEvents+0xa99 [minkernel\\wdf\\framework\\shared\\irphandlers\\io\\fxioqueue.cpp @ 3125] ffff828a`3e187160 fffff804`68f02ad1 : 000039fe`db480200 000039fe`e276d688 fffff804`68f07000 ffffc601`00000001 : Wdf01000!imp_WdfRequestForwardToIoQueue+0x343 [minkernel\\wdf\\framework\\shared\\core\\fxrequestapi.cpp @ 3130] ffff828a`3e187230 fffff804`5205fd38 : ffffc601`24b7fd01 ffffc601`1d35ddd0 ffffc601`24b7fd20 ffffc601`24b7fd20 : StcMcuI2cDriver!OnTopLevelIoDefault+0x121 [D:\\Project\\Drivers\\Windows\\SourceCode\\Pch_I2C\\Source\\1.2\\sys\\device.cpp @ 511] ffff828a`3e1872b0 fffff804`5205eae9 : fffff804`68f07000 fffff804`52104c28 00000000`0000000b ffffc601`1d892970 : Wdf01000!FxIoQueue::DispatchRequestToDriver+0x1e8 [minkernel\\wdf\\framework\\shared\\irphandlers\\io\\fxioqueue.cpp @ 3414] ffff828a`3e187330 fffff804`520793ec : ffffc601`1d892970 ffff828a`3e187800 00000000`00000000 00000002`00000048 : Wdf01000!FxIoQueue::DispatchEvents+0xa99 [minkernel\\wdf\\framework\\shared\\irphandlers\\io\\fxioqueue.cpp @ 3125] ffff828a`3e187440 fffff804`52078d89 : 00000000`00000000 ffffc601`23d6ca00 ffff828a`3e187800 fffff804`bfd41401 : Wdf01000!FxPkgIo::DispatchStep1+0x5ec [minkernel\\wdf\\framework\\shared\\irphandlers\\io\\fxpkgio.cpp @ 324] ffff828a`3e187520 fffff804`520972e2 : ffffc601`23d6ca30 00000000`24b7fd20 ffffc601`1d13d8b0 fffff804`bfccdc39 : Wdf01000!FxPkgIo::Dispatch+0x59 [minkernel\\wdf\\framework\\shared\\irphandlers\\io\\fxpkgio.cpp @ 119] ffff828a`3e187580 fffff804`bfc987ed : 00000000`00000000 00000000`00000000 ffffc601`1d08c8d0 ffffc601`27122d10 : Wdf01000!FxDevice::DispatchWithLock+0x232 [minkernel\\wdf\\framework\\shared\\core\\fxdevice.cpp @ 1445] ffff828a`3e1875e0 fffff804`c02d33a8 : ffffc601`27122d10 ffff828a`3e187690 ffffc601`1d08c8d0 00000000`00000001 : nt!IofCallDriver+0xcdffff828a`3e187620 fffff804`c02d21f2 : 00000000`42dd2ce6 00000000`00000001 ffffc601`27122d10 00000000`00000001 : nt!IopSynchronousServiceTail+0x1c8ffff828a`3e1876d0 fffff804`c02d187e : 00000000`00000000 fffff804`bfcaaa80 00000000`00000000 00007ff8`ed5a58f0 : nt!IopXxxControlFile+0x962ffff828a`3e187940 fffff804`c00b7c55 : 00000267`bf8d27c0 00000267`bf9720a0 000000f5`6f8a1000 00000267`be7da980 : nt!NtDeviceIoControlFile+0x5effff828a`3e1879b0 00007ff9`59541be4 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!KiSystemServiceCopyEnd+0x25000000f5`703ff728 00000000`00000000 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : 0x00007ff9`59541be4FAULTING_SOURCE_LINE:  D:\\Project\\Drivers\\Windows\\SourceCode\\Pch_I2C\\Source\\1.2\\sys\\peripheral.cppFAULTING_SOURCE_FILE:  D:\\Project\\Drivers\\Windows\\SourceCode\\Pch_I2C\\Source\\1.2\\sys\\peripheral.cppFAULTING_SOURCE_LINE_NUMBER:  129FAULTING_SOURCE_CODE:     125:         &quot;Closing handle to SPB target&quot;);   126:    127:     WdfIoTargetClose(pDevice-&gt;SpbController);   128: &gt;  129:     FuncExit(TRACE_FLAG_SPBAPI);   130:        131:     return STATUS_SUCCESS;   132: &#125;   133:    134: VOIDSYMBOL_NAME:  StcMcuI2cDriver!SpbPeripheralClose+8fMODULE_NAME: StcMcuI2cDriverIMAGE_NAME:  StcMcuI2cDriver.sysSTACK_COMMAND:  .thread ; .cxr ; kbBUCKET_ID_FUNC_OFFSET:  8fFAILURE_BUCKET_ID:  0x10D_5_StcMcuI2cDriver!SpbPeripheralCloseOSPLATFORM_TYPE:  x64OSNAME:  Windows 10FAILURE_ID_HASH:  &#123;862ad8cf-4de1-9dc0-849b-4a6423d819ac&#125;Followup:     MachineOwner---------23: kd&gt; ln StcMcuI2cDriver+0x8fBrowse moduleSet bu breakpoint(fffff804`68f01000)   StcMcuI2cDriver!OnDeviceAdd+0xffffffff`ffffffff   |  (fffff804`68f01740)   StcMcuI2cDriver!OnDriverCleanup\n","categories":["Windbg"],"tags":["Windbg"]},{"title":"[Gerrit] 1. Install Gerrit","url":"/2024/02/24/Gerrit/Setup_SOP/1.%20Install%20Gerrit/Install_Gerrit/","content":"\nThis topic is used to record how to set up the gerrit server under Ubuntu.\n\n1. Environment\nOS: Ubuntu 22.04.4 LTS \nGit: 2.34.1\nJdk: 19.0.2\nagancha: 2.4.52\nGerrit: 3.10.0\nLocal ip address: 192.168.77.28\n\n2. Configuration Steps2.1 Update the package listsudo apt-get update\n\n2.2 Install Gitsudo apt install git\n\n2.3 Install Jdksudo sudo apt install openjdk-19-jre-headless\n\n2.4 Install Apache2sudo sudo apt install apache2\n\n2.5 Create Gerrit_Workplace folder under Home sitemkdir Gerrit_Workplace\n\n2.6 Download Gerrit 3.10.0 to Gerrit_Workplace folersudo wget -P /home/administrator/Gerrit_Workplace/ https://gerrit-releases.storage.googleapis.com/gerrit-3.10.0.war\n\n2.7 Install Gerrit 3.10.0 to Gerrit_Workplace folerjava -jar /home/administrator/Gerrit_Workplace/gerrit-3.10.0.war init -d /home/administrator/Gerrit_Workplace/\n\n\nAfter executing the above command, you will enter the configuration interface of gerrit, please press enter to execute the default configuration except [Plugins] part, and we will modify the configuration in step 8, the following is the log of the default configuration.\nUsing secure store: com.google.gerrit.server.securestore.DefaultSecureStore[2024-06-29 10:51:45,119] [main] INFO    com.google.gerrit.server.config.GerritServerConfigProvider : No   /home/administrator/Gerrit_Workplace/etc/gerrit.config; assuming defaults*** Gerrit Code Review 3.10.0*** *** Git Repositories*** Location of Git repositories   [git]: *** JGit Configuration*** Auto-configured &quot;receive.autogc = false&quot; to disable auto-gc after git-  receive-pack.*** Index*** Type                           [lucene]: *** User Authentication*** Authentication method          [openid/?]: Enable signed push support     [y/N]? *** Review Labels*** Install Verified label         [y/N]? *** Email Delivery*** SMTP server hostname           [localhost]: SMTP server port               [(default)]: SMTP encryption                [none/?]: SMTP username                  : *** Container Process*** Run as                         [administrator]: Java runtime                   [/usr/lib/jvm/java-19-openjdk-amd64]: Copy gerrit-3.10.0.war to /home/administrator/Gerrit_Workplace/bin/gerrit.war   [Y/n]? Copying gerrit-3.10.0.war to   /home/administrator/Gerrit_Workplace/bin/gerrit.war*** SSH Daemon*** Listen on address              [*]: Listen on port                 [29418]: Generating SSH host key ... rsa... ed25519... ecdsa 256... ecdsa 384... ecdsa   521... done*** HTTP Daemon*** Behind reverse proxy           [y/N]? Use SSL (https://)             [y/N]? Listen on address              [*]: Listen on port                 [8080]: Canonical URL                  [http://administrator-Default-string:8080/]: *** Cache*** *** Plugins*** Installing plugins.Install plugin codemirror-editor version v3.10.0 [y/N]? yInstalled codemirror-editor v3.10.0Install plugin commit-message-length-validator version v3.10.0 [y/N]? yInstalled commit-message-length-validator v3.10.0Install plugin delete-project version v3.10.0 [y/N]? yInstalled delete-project v3.10.0Install plugin download-commands version v3.10.0 [y/N]? yInstalled download-commands v3.10.0Install plugin gitiles version v3.10.0 [y/N]? yInstalled gitiles v3.10.0Install plugin hooks version v3.10.0 [y/N]? yInstalled hooks v3.10.0Install plugin plugin-manager version v3.10.0 [y/N]? yInstalled plugin-manager v3.10.0Install plugin replication version v3.10.0 [y/N]? yInstalled replication v3.10.0Install plugin reviewnotes version v3.10.0 [y/N]? yInstalled reviewnotes v3.10.0Install plugin singleusergroup version v3.10.0 [y/N]? yInstalled singleusergroup v3.10.0Install plugin webhooks version v3.10.0 [y/N]? yInstalled webhooks v3.10.0Initializing plugins.Jun 29, 2024 10:56:11 AM   org.apache.lucene.store.MemorySegmentIndexInputProvider &lt;init&gt;INFO: Using MemorySegmentIndexInput with Java 19; to disable start with -  Dorg.apache.lucene.store.MMapDirectory.enableMemorySegments=false============================================================================Welcome to the Gerrit communityFind more information on the homepage: https://www.gerritcodereview.comDiscuss Gerrit on the mailing list: https://groups.google.com/g/repo-discuss============================================================================Initialized /home/administrator/Gerrit_WorkplaceInit complete, reindexing accounts,changes,groups,projects with: reindex --  site-path /home/administrator/Gerrit_Workplace --threads 1 --index accounts -  -index changes --index groups --index projectsReindexed 0 documents in   accounts index in 0.0s (0.0/s)Index accounts in version 14 is readyReindexing groups:      100% (2/2)Reindexed 2 documents in groups index in 0.1s (15.6/s)Index groups in version 11 is readyReindexing changes: Slicing projects: 100% (2/2), done    Reindexed 0 documents in changes index in 0.5s (0.0/s)Index changes in version 86 is readyReindexing projects:    100% (2/2)Reindexed 2 documents in projects index in 0.1s (27.4/s)Index projects in version 9 is ready\n\n2.8 Modify the installation configuration\nSwtich the path of terminal to &#x2F;home&#x2F;administrator&#x2F;Gerrit_Workplace&#x2F;etc&#x2F;\ncd /home/administrator/Gerrit_Workplace/etc/\n\nView gerrit.config, the below is the default configuration  \nvim gerrit.config [or] gedit gerrit.config\n\n# default gerrit.config:[gerrit] basePath = git canonicalWebUrl = http://administrator-Default-string:8080/ serverId = 9cbbca33-3ef1-4a00-ace1-35d249b377aa[container] javaOptions = &quot;-  Dflogger.backend_factory=com.google.common.flogger.backend.log4j.Log4jBackend  Factory#getInstance&quot; javaOptions = &quot;-  Dflogger.logging_context=com.google.gerrit.server.logging.LoggingContext#getI  nstance&quot; user = administrator javaHome = /usr/lib/jvm/java-19-openjdk-amd64[index] type = lucene[auth] type = OPENID[receive] enableSignedPush = false[sendemail] smtpServer = localhost[sshd] listenAddress = *:29418[httpd] listenUrl = http://*:8080/[cache] directory = cache\n\nModify gerrit.config, the below is the modified configuration  \nsudo vim gerrit.config [or] sudo gedit gerrit.config\n\n# Modify gerrit.config[gerrit] # The base path where the Git repository is stored basePath = git  # The URL of the Gerrit web interface canonicalWebUrl = https://192.168.77.28:8081/  # A unique identifier for a Gerrit server serverId = 9cbbca33-3ef1-4a00-ace1-35d249b377aa  [container] # Configure the logging backend javaOptions = &quot;-  Dflogger.backend_factory=com.google.common.flogger.backend.log4j.Log4jBackend  Factory#getInstance&quot;  # Configure the logging context javaOptions = &quot;-  Dflogger.logging_context=com.google.gerrit.server.logging.LoggingContext#getI  nstance&quot;  # The user who will run Gerrit services user = administrator  # The path to the Java runtime environment javaHome = /usr/lib/jvm/java-19-openjdk-amd64  [index] # Use Lucene as the index backend type = lucene  [auth] # # Use HTTP authentication type = HTTP  # Usernames are not case-sensitive userNameCaseInsensitive = true[receive] # Disable signature push enableSignedPush = false[sendemail] # Enable email sending enable = true  # SMTP server address smtpServer = smtp.sk1999.com  # SMTP server port smtpServerPort = 465    # SMTP users smtpUser = diaosuyu@sk1999.com  # The sender&#x27;s address when sending the message from = Code Review &lt;diaosuyu@sk1999.com&gt;  # SSL encryption is used smtpEncryption = ssl  # Disable SSL validation sslVerify = false  # SMTP user password smtpPass = VTHRtCdf9ytdsQxJ[sshd] # SSHD listening address and port listenAddress = *:29418[httpd] # URL of the HTTPD listener listenUrl = proxy-https://192.168.77.28:8080/[cache] # Cache directory directory = cache[log] # Logging level level = DEBUG\n\nSwtich the path of terminal to &#x2F;home&#x2F;administrator&#x2F;Gerrit_Workplace&#x2F;\ncd /home/administrator/Gerrit_Workplace/\n\nCreate key folder and create SSL Certificate\nmkdir keycd key/openssl req -x509 -nodes -days 365 \\  -newkey rsa:2048 \\  -keyout gerrit.key \\  -out gerrit.crt \\  -subj &quot;/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd/CN=192.168.77.28&quot; \\  -addext &quot;subjectAltName=IP:192.168.77.28&quot;\n\n2.9 Modify the Apache2 configuration\nSwtich the path of terminal to &#x2F;etc&#x2F;apache2\ncd /etc/apache2\n\nCreate a new file named gerrit_httpd.conf\nsudo touch gerrit_httpd.conf\n\nModify gerrit_httpd.conf\nsudo vim gerrit_httpd.conf [or] sudo gedit gerrit_httpd.conf\n\n# gerrit_httpd.conf:&lt;VirtualHost *:8081&gt;    ServerName 192.168.77.40    ProxyRequests Off    ProxyVia Off    ProxyPreserveHost On    SSLEngine on    SSLCertificateFile /home/administrator/Gerrit_Workplace/key/gerrit.crt    SSLCertificateKeyFile /home/administrator/Gerrit_Workplace/key/gerrit.key        &lt;Proxy *&gt;          Order deny,allow          Allow from all    &lt;/Proxy&gt;    &lt;Location /login/&gt;      AuthType Basic      AuthName &quot;Gerrit Code Review&quot;      Require valid-user      AuthBasicProvider file      AuthUserFile /home/administrator/Gerrit_Workplace/users/gerrit.password     &lt;/Location&gt;    AllowEncodedSlashes On    ProxyPass / http://192.168.77.40:8080/ nocanon    ProxyPassReverse / http://192.168.77.40:8080/ nocanon&lt;/VirtualHost&gt;\n\nModify ports.conf, adds a listen on port 8081\nsudo vim ports.conf [or] sudo gedit ports.conf\n\n# ports.conf:# If you just change the port or add more ports here, you will likely also# have to change the VirtualHost statement in# /etc/apache2/sites-enabled/000-default.confListen 80&lt;IfModule ssl_module&gt; Listen 443&lt;/IfModule&gt;&lt;IfModule mod_gnutls.c&gt; Listen 443&lt;/IfModule&gt;# &lt;Sam_Diao-20240629&gt;+# For gerrit server useListen 8081# &lt;Sam_Diao-20240629&gt;-# vim: syntax=apache ts=4 sw=4 sts=4 sr noet\n\nModify apache2.conf, Include gerrit_httpd.conf at the end of apache2.conf\nsudo vim apache2.conf [or] sudo gedit apache2.conf\n\n# at the end of apache2.conf:# &lt;Sam_Diao-20240629&gt;+# For gerrit server useInclude gerrit_httpd.conf# &lt;Sam_Diao-20240629&gt;-\n\nExecute the following command\nsudo a2enmod proxysudo a2enmod proxy_httpsudo a2enmod proxy_balancersudo a2enmod auth_basicsudo a2enmod headerssudo a2enmod lbmethod_byrequests\n\nSwtich the path of terminal to &#x2F;etc&#x2F;apache2&#x2F;mods-enabled\ncd /etc/apacha2/mods-enabled\n\nExecute the following command\nsudo ln -s proxy.loadsudo ln -s proxy.confsudo ln -s proxy_http.loadsudo ln -s proxy_balancer.confsudo ln -s proxy_balancer.loadsudo ln -s rewrite.loadsudo ln -s ssl.confsudo ln -s ssl.loadsudo ln -s slotmem_shm.loadsudo ln -s socache_shmcb.load\n\n2.10 Create a login authentication file under Gerrit_Workplace\nSwtich the path of terminal to &#x2F;home&#x2F;administrator&#x2F;Gerrit_Workplace&#x2F;\ncd /home/administrator/Gerrit_Workplace/\n\nCreate users folder for save name and password of users who will login gerrit\nmkdir users\n\nSwtich the path of terminal to users&#x2F;\ncd users/\n\nCreate an administrator accout for gerrit\nhtpasswd -c gerrit.password administrator\n\nbash log:$ htpasswd -c gerrit.password administratorNew password: Re-type new password: Adding password for user administrator\n\nCreate an guest accout for gerrit\nhtpasswd -m gerrit.password guest\n\nbash log:$ htpasswd -m gerrit.password guestNew password: Re-type new password: Adding password for user guest\n\n2.11 Modify the access permission of Apache2\nApache2 is run as a www-data user by default, use the following command to determine what the user is.\nps aux | grep apache2\n\ngerrit.password is created by administrator, other users have no permission to access, like user www-data, so we need to add www-data into group of administrator, then www-data can access gerrit.password.\nsudo usermod -aG administrator www-data\n\n2.12 Restart the Gerrit and Apache2\nSwtich the path of terminal to &#x2F;home&#x2F;administrator&#x2F;Gerrit_Workplace&#x2F;bin\ncd /home/administrator/Gerrit_Workplace/bin\n\nRestart Gerrit.\nsudo ./gerrit.sh restart\n\nEnable the SSL module and site configuration, then restart Apache2.\nsudo a2enmod sslsudo a2ensite default-sslsudo systemctl restart apache2\n\nTips: The following commands or files are used to check and correct errors in the event of errors:\n1. sudo systemctl status apache22. journalctl -xeu apache2.service3. /var/log/apache2/error.log4. /home/administrator/Gerrit_Workplace/log/error_log\n\n3. Login Verification3.1 Open browser and login\nOpen browser and enter 192.168.77.28:8081, then enter the name and password of the administrator account that you have just registered.\n192.168.77.28:8081\n\n\n\n\n3.2 Check dashboard\nif everything is working properly then will go to dashboard automatically.\n\n\n\n3.3 Check administrator account settings\nClick the username in the top right corner, and then click Setting, if everything is working properly, the account ID is 1000000 that means administrator is super manager(By default, the account for this number is super manager).\n\n\n\n3.4 Check guest account settings\nIn the same way, you can check the information of the guest account and note that the guest account does not have administrative privileges.\n\n\n\n4. Option Configuration4.1 Auto-start Gerrit and Apache2 on boot\nGerrit will automatically turn off after os reboot, if you want Gerrit to turn on automatically every time that you turn on the device, please perform the following configuration.\n\nSet the gerrit service to start automatically when ubuntu is powered on\nsudo vim /etc/systemd/system/gerrit.service# Add the following Setting[Unit]Description=Gerrit Code ReviewAfter=network.target[Service]Type=forkingUser=administratorExecStart=/home/administrator/Gerrit_Workplace/bin/gerrit.sh restartExecStop=/home/administrator/Gerrit_Workplace/bin/gerrit.sh stopWorkingDirectory=/home/administrator/Gerrit_WorkplaceRestart=on-failure[Install]WantedBy=multi-user.target\n\nApache2 auto start\nsudo systemctl daemon-reloadsudo systemctl enable apache2sudo systemctl enable gerritsudo systemctl start apache2sudo systemctl start gerrit\n\nApache2 Status check\nsudo systemctl status apache2sudo systemctl status gerrit\n\n4.2 Configure static IP address\nBy default, dynamic IP addresses are used, if you wish to use a static IP address, please use this section to set the settings.\n\nConfigure static ip address\n\nEnable the management of specific network interfaces\nsudo vim /etc/NetworkManager/NetworkManager.conf   [main]  plugins=ifupdown,keyfile  [ifupdown]  managed=true  [device]  wifi.scan-rand-mac-address=nosudo systemctl restart NetworkManager\n\nSet network for access external web\nsudo vim /etc/resolv.conf# add at the bottomnameserver 8.8.8.8nameserver 8.8.4.4sudo service NetworkManager stopsudo rm /var/lib/NetworkManager/NetworkManager.statesudo service NetworkManager start\n\n4.3 Ensure Apache Can Access Gerrit’s Directory on External Hard Drive\nIf you’re setting up Gerrit on an external hard drive and sharing the folder for access by Ubuntu, you may encounter issues where Apache cannot access the Gerrit password file. Follow these steps to resolve potential access problems:\n\n4.3.1 Ensure Apache Can Access the Directory\nThe directory itself must also have read permissions for the Apache user (www-data). Run the following command to ensure the /media/sf_VirtualBox/Gerrit_Workplace/users/ directory is accessible:\nsudo chmod 755 /media/sf_VirtualBox/Gerrit_Workplace/users\n\n4.3.2 Modify File Permissions\nEnsure that the gerrit.password file is readable by the owner, group members, and others by using the following command:\nsudo chmod 644 /media/sf_VirtualBox/Gerrit_Workplace/users/gerrit.password\n\nThis will grant read permissions to root, the vboxsf group, and others.\n\n\n4.3.3 Check If www-data Has Permissions\nIf the permissions are correctly set but the problem persists, it may be because the www-data user is not part of the group for that directory. You can add the www-data user to the vboxsf group to give it access to the directory and files:\nsudo usermod -aG vboxsf www-data\n\n4.3.4 Restart Apache\nThen restart Apache so the www-data user can gain access:\nsudo systemctl restart apache2\n\n4.3.5 Confirm vboxsf Group Permissions\nEnsure the vboxsf group has appropriate permissions for the /media/sf_VirtualBox/ directory and all of its subdirectories and files. Use the following command to check the directory’s permissions:\nls -l /media/sf_VirtualBox\n\n","categories":["Gerrit"],"tags":["Gerrit"]},{"title":"[Gerrit] 3. Configure Windows Oa of Users","url":"/2024/07/04/Gerrit/Setup_SOP/3.%20Configure%20Windows%20Oa%20of%20Users/Configure_Windows_Oa_Of_Users/","content":"\nThis topic is used to record how to configure Windows Oa of Users.You must have successfully completed the first and second chapter before you can execute this chapter.\n\n1. Login your account  \n2. Verify your Email  \n\nYou will receive a verification email, then open the link in the email.\n\n\nThe email address has been verified.\n\n\n\n3. Configure SSH Keys\nOpen your Git Bash anywhere, then run the command down below:\nssh-keygen -t rsa -b 4096 -C &quot;your_email@example.com&quot;\n\n \n\nFollow the prompt address to locate the public key and copy it to the SSH Keys bar\n\n \n4. Configure your information under Git4.1 Configure Git with Git Bash\nOpen your Git Bash anywhere, then run the command down below:  \n\nuser.name is the username you just logged into gerrit  \n\nuser.email is the address you just used to authenticate your email address  \nexample:git config --global user.name &quot;Sam_Diao&quot;git config --global user.email &quot;your_email@example.com&quot;\n\n4.2 Configure Git with TortoiseGit\nIf you want to use TortoiseGit instead of Git Bash, Here’s what you need to do:\nPlease note that the below three steps require you to install TortoiseGit correctly!\n\n4.2.1 Generate SSH keys with PuttyGen\nRun puttygen.exe to create a public-private key pair, input your name to Key comment bar, then save public and private key.\n\n\n\n4.2.2 Copy public key to SSH Keys\nUsing the same method as above, copy the public key which has generated by puttygen.exe to the SSH Keys bar.\n\n4.2.3 Configure Pageant with private key\nRun pageant.exe and add the private key which has generated by puttygen.exe to Pegeant Key List, like this:\n\n\n\n5. Copy [commit-msg] to your Git hooks folder\nFor example, my git hooks folder is C:\\Software\\Git\\mingw64\\share\\git-core\\templates\\hooks\n\n \n6. Test Workflow6.1 Clone the test repository in gerrit with Git Bash \n\nIf you encounter the following problem:\n\nCloning into &#x27;SuZhou_Test&#x27;...@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!Someone could be eavesdropping on you right now (man-in-the-middle attack)!It is also possible that a host key has just been changed.The fingerprint for the ED25519 key sent by the remote host isSHA256:U3AS9BcRFdnpRSfzDe4k/Jipa1sk2ez5XaTxRehpw4k.Please contact your system administrator.Add correct host key in /c/Users/Administrator/.ssh/known_hosts to get rid of this message.Offending ED25519 key in /c/Users/Administrator/.ssh/known_hosts:1Host key for [192.168.77.28]:29418 has changed and you have requested strict checking.Host key verification failed.fatal: Could not read from remote repository.Please make sure you have the correct access rightsand the repository exists.\n\n\nPlease run this command to fix:\n\nssh-keygen -R [192.168.77.28]:29418\n\n6.2 Perpare test file\nCreate a file named UploadTest.txt in the test repository and input something, then save this file:\n\n \n6.3 Push test file to Gerrit with Git Bashgit add UploadTest.txtgit commit -m &quot;push test file to Gerrit&quot;git push origin head:refs/for/master\n\n \n\nIf you have this pop-up window appearing:\n\n \n\nThe Username is your gerrit account name, not your email address, please get the password from here:\n\n \n7. Review your code commits in Gerrit \n","categories":["Gerrit"],"tags":["Gerrit"]},{"title":"[Jenkins] 1. Install Jenkins","url":"/2025/08/21/Jenkins/Setup_SOP/1.%20Install%20Jenkins/Install_Jenkins/","content":"\nThis topic is used to record how to set up the Jenkins server under Ubuntu.\n\n1. Environment\nOS: Ubuntu 22.04.4 LTS\nJenkins: 2.516.2\nJdk: 21.0.8\nLocal ip address: 192.168.77.199\n\n2. Configuration Steps2.1 Update the package listsudo apt-get update\n\n2.2 Install JDK 21sudo apt install -y openjdk-21-jre-headlessubuntu@ubuntu-VirtualBox:/media/sf_VirtualBoxShare/Jenkins_Workplace$ sudo apt install -y openjdk-17-jre-headlessReading package lists... DoneBuilding dependency tree... DoneReading state information... DoneSuggested packages:  fonts-ipafont-gothic fonts-ipafont-mincho fonts-wqy-microhei | fonts-wqy-zenheiThe following NEW packages will be installed:  openjdk-17-jre-headless0 upgraded, 1 newly installed, 0 to remove and 59 not upgraded.Need to get 48.3 MB of archives.After this operation, 193 MB of additional disk space will be used.Get:1 http://cn.archive.ubuntu.com/ubuntu jammy-updates/universe amd64 openjdk-17-jre-headless amd64 17.0.16+8~us1-0ubuntu1~22.04.1 [48.3 MB]Fetched 48.3 MB in 3s (15.7 MB/s)                  Selecting previously unselected package openjdk-17-jre-headless:amd64.(Reading database ... 207010 files and directories currently installed.)Preparing to unpack .../openjdk-17-jre-headless_17.0.16+8~us1-0ubuntu1~22.04.1_amd64.deb ...Unpacking openjdk-17-jre-headless:amd64 (17.0.16+8~us1-0ubuntu1~22.04.1) ...Setting up openjdk-17-jre-headless:amd64 (17.0.16+8~us1-0ubuntu1~22.04.1) ...ubuntu@ubuntu-VirtualBox:/media/sf_VirtualBoxShare/Jenkins_Workplace$ java --versionopenjdk 21.0.8 2025-07-15OpenJDK Runtime Environment (build 21.0.8+9-Ubuntu-0ubuntu122.04.1)OpenJDK 64-Bit Server VM (build 21.0.8+9-Ubuntu-0ubuntu122.04.1, mixed mode, sharing)\n\n2.3 Create Jenkins_Workplace foldermkdir Jenkins_Workplace\n\n2.4 Download Jenkins 2.516.2 to Jenkins_Workplace folersudo wget -P ./ https://mirrors.jenkins.io/war-stable/2.516.2/jenkins.warubuntu@ubuntu-VirtualBox:/media/sf_VirtualBoxShare/Jenkins$ sudo wget -P ./ https://mirrors.jenkins.io/war-stable/2.516.2/jenkins.war[sudo] password for ubuntu: --2025-08-21 17:51:49--  https://mirrors.jenkins.io/war-stable/2.516.2/jenkins.warResolving mirrors.jenkins.io (mirrors.jenkins.io)... 20.7.178.24, 2603:1030:408:5::15aConnecting to mirrors.jenkins.io (mirrors.jenkins.io)|20.7.178.24|:443... connected.HTTP request sent, awaiting response... 302 FoundLocation: https://mirrors.tuna.tsinghua.edu.cn/jenkins/war-stable/2.516.2/jenkins.war [following]--2025-08-21 17:51:51--  https://mirrors.tuna.tsinghua.edu.cn/jenkins/war-stable/2.516.2/jenkins.warResolving mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)... 101.6.15.130, 2402:f000:1:400::2Connecting to mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)|101.6.15.130|:443... connected.HTTP request sent, awaiting response... 200 OKLength: 87485720 (83M) [application/java-archive]Saving to: ‘./jenkins.war’jenkins.war                100%[========================================&gt;]  83.43M  45.8MB/s    in 1.8s    2025-08-21 17:51:54 (45.8 MB/s) - ‘./jenkins.war’ saved [87485720/87485720]\n\n2.5 Install Jenkins 2.516.2 to Jenkins_Workplace folerjava -jar jenkins.war --httpPort=8000\n\n\nAfter executing the above command, the Jenkins engine is power on, the following is the log of the default configuration.\n\nubuntu@ubuntu-VirtualBox:/media/sf_VirtualBoxShare/Jenkins_Workplace$ java -jar jenkins.war --httpPort=8000Running from: /media/sf_VirtualBoxShare/Jenkins_Workplace/jenkins.warwebroot: /home/ubuntu/.jenkins/war2025-08-21 10:22:52.882+0000 [id=1]\tINFO\twinstone.Logger#logInternal: Beginning extraction from war file2025-08-21 10:22:52.930+0000 [id=1]\tWARNING\to.e.j.ee9.nested.ContextHandler#setContextPath: Empty contextPath2025-08-21 10:22:52.971+0000 [id=1]\tINFO\torg.eclipse.jetty.server.Server#doStart: jetty-12.0.22; built: 2025-06-02T15:25:31.946Z; git: 335c9ab44a5591f0ea941bf350e139b8c4f5537c; jvm 21.0.8+9-Ubuntu-0ubuntu122.04.12025-08-21 10:22:53.225+0000 [id=1]\tINFO\to.e.j.e.w.StandardDescriptorProcessor#visitServlet: NO JSP Support for /, did not find org.eclipse.jetty.ee9.jsp.JettyJspServlet2025-08-21 10:22:53.268+0000 [id=1]\tINFO\to.e.j.s.DefaultSessionIdManager#doStart: Session workerName=node02025-08-21 10:22:53.530+0000 [id=1]\tINFO\thudson.WebAppMain#contextInitialized: Jenkins home directory: /home/ubuntu/.jenkins found at: $user.home/.jenkins2025-08-21 10:22:53.624+0000 [id=1]\tINFO\to.e.j.s.handler.ContextHandler#doStart: Started oeje9n.ContextHandler$CoreContextHandler@7577b641&#123;Jenkins v2.516.2,/,b=file:///home/ubuntu/.jenkins/war/,a=AVAILABLE,h=oeje9n.ContextHandler$CoreContextHandler$CoreToNestedHandler@3704122f&#123;STARTED&#125;&#125;2025-08-21 10:22:53.630+0000 [id=1]\tINFO\to.e.j.server.AbstractConnector#doStart: Started ServerConnector@7561db12&#123;HTTP/1.1, (http/1.1)&#125;&#123;0.0.0.0:8000&#125;2025-08-21 10:22:53.635+0000 [id=1]\tINFO\torg.eclipse.jetty.server.Server#doStart: Started oejs.Server@57c758ac&#123;STARTING&#125;[12.0.22,sto=0] @1055ms2025-08-21 10:22:53.636+0000 [id=39]\tINFO\twinstone.Logger#logInternal: Winstone Servlet Engine running: controlPort=disabled2025-08-21 10:22:53.723+0000 [id=38]\tINFO\tjenkins.model.Jenkins#&lt;init&gt;: Starting version 2.516.22025-08-21 10:22:53.777+0000 [id=48]\tINFO\tjenkins.InitReactorRunner$1#onAttained: Started initialization2025-08-21 10:22:53.782+0000 [id=55]\tINFO\tjenkins.InitReactorRunner$1#onAttained: Listed all plugins2025-08-21 10:22:54.231+0000 [id=55]\tINFO\tjenkins.InitReactorRunner$1#onAttained: Prepared all plugins2025-08-21 10:22:54.234+0000 [id=48]\tINFO\tjenkins.InitReactorRunner$1#onAttained: Started all plugins2025-08-21 10:22:54.234+0000 [id=50]\tINFO\tjenkins.InitReactorRunner$1#onAttained: Augmented all extensions2025-08-21 10:22:54.318+0000 [id=50]\tINFO\tjenkins.InitReactorRunner$1#onAttained: System config loaded2025-08-21 10:22:54.319+0000 [id=49]\tINFO\tjenkins.InitReactorRunner$1#onAttained: System config adapted2025-08-21 10:22:54.319+0000 [id=49]\tINFO\tjenkins.InitReactorRunner$1#onAttained: Loaded all jobs2025-08-21 10:22:54.320+0000 [id=49]\tINFO\tjenkins.InitReactorRunner$1#onAttained: Configuration for all jobs updated2025-08-21 10:22:54.333+0000 [id=75]\tINFO\thudson.util.Retrier#start: Attempt #1 to do the action check updates server2025-08-21 10:22:54.537+0000 [id=54]\tINFO\tjenkins.install.SetupWizard#init: ***************************************************************************************************************************************************************************************Jenkins initial setup is required. An admin user has been created and a password generated.Please use the following password to proceed to installation:2781b125f4cc45b6a912324b1e710b4bThis may also be found at: /home/ubuntu/.jenkins/secrets/initialAdminPassword***************************************************************************************************************************************************************************************2025-08-21 10:23:00.033+0000 [id=54]\tINFO\tjenkins.InitReactorRunner$1#onAttained: Completed initialization2025-08-21 10:23:00.045+0000 [id=38]\tINFO\thudson.lifecycle.Lifecycle#onReady: Jenkins is fully up and running2025-08-21 10:23:03.133+0000 [id=75]\tINFO\th.m.DownloadService$Downloadable#load: Obtained the updated data file for hudson.tasks.Maven.MavenInstaller2025-08-21 10:23:03.133+0000 [id=75]\tINFO\thudson.util.Retrier#start: Performed the action check updates server successfully at the attempt #1\n\n2.6 Try to login\nTry to entry http://192.168.77.119:8000 use browser\n\n\nInput the initialAdminPassword which you can find from &#x2F;home&#x2F;ubuntu&#x2F;.jenkins&#x2F;secrets&#x2F;initialAdminPassword and click Continue button\n\n\n2.7 Install plugins\nif no errors incur, you will see the plungins page\n\n\nclick the left one(Install suggested plugins)\n\n\n\n2.8 Create User Account\nif no errors incur, you will see the Create First Admin User page\n\n\nclick Skip and continue as admin button\n\n\n2.9 Instance Configuration\nif no errors incur, you will see the Instance Configuration page\n\n\nclick Save and Finish button\n\n\n2.10 Finish\nif no errors incur, you will see the ready page\n\nclick Save and Finish button\n\n\n2.11 Login\nEntry http://192.168.77.119:8000 use browser\n\nInput the initialAdminPassword which you can find from &#x2F;home&#x2F;ubuntu&#x2F;.jenkins&#x2F;secrets&#x2F;initialAdminPassword and click Sign in button\n\n\n\n\n3. Strongly Recommend Configuration3.1 Auto-start Jenkins on bootJenkins will automatically turn off after OS reboot, if you want Jenkins to turn on automatically every time that you turn on the device, please perform the following configuration.\n\nSet the Jenkins service to start automatically when ubuntu is powered on\n\n3.1.1 Create the Jenkins directorysudo mkdir -p /opt/jenkins\n\n3.1.2 Copy the Jenkins WAR file to the directorysudo cp /media/sf_VirtualBoxShare/Jenkins_Workplace/jenkins.war /opt/jenkins/\n\n3.1.3 Set ownership to the ubuntu usersudo chown -R ubuntu:ubuntu /opt/jenkins\n\n3.1.4 Create a Java TrustStore and import the Gerrit certificate\nRemove any existing TrustStore (if present):\nsudo rm -f /home/ubuntu/gerritTrustStore.jks\n\nCreate an empty TrustStore with a temporary key entry:\nsudo keytool -genkey -alias temp \\  -keystore /home/ubuntu/gerritTrustStore.jks \\  -storepass changeit \\  -keyalg RSA -keysize 2048 \\  -dname &quot;CN=temp&quot;\n\nDelete the temporary alias:\nsudo keytool -delete -alias temp \\  -keystore /home/ubuntu/gerritTrustStore.jks \\  -storepass changeit\n\nImport the Gerrit certificate into the TrustStore:\nsudo keytool -importcert -trustcacerts -alias gerrit \\  -file /home/ubuntu/Gerrit_Workplace/key/gerrit.crt \\  -keystore /home/ubuntu/gerritTrustStore.jks \\  -storepass changeit -noprompt\n\nVerify the certificate was imported successfully:\nsudo keytool -list -v -keystore /home/ubuntu/gerritTrustStore.jks -storepass changeit\n\n3.1.5 Create a systemd service file for Jenkinssudo nano /etc/systemd/system/jenkins.service# Add the following content:[Unit]Description=Jenkins ServerAfter=network.target[Service]User=ubuntuGroup=ubuntuWorkingDirectory=/opt/jenkinsExecStart=/usr/bin/java -Djavax.net.ssl.trustStore=/home/ubuntu/gerritTrustStore.jks -Djavax.net.ssl.trustStorePassword=changeit -jar /opt/jenkins/jenkins.war --httpPort=8000Restart=always[Install]WantedBy=multi-user.target\n\n3.1.6 Reload systemd to apply the new servicesudo systemctl daemon-reload\n\n3.1.7 Start Jenkins and enable it to auto-start on boot:sudo systemctl start jenkinssudo systemctl enable jenkinssudo systemctl status jenkins\n","categories":["Jenkins"],"tags":["Jenkins"]},{"title":"[Gerrit] 2. Configure Gerrit on Website","url":"/2024/06/29/Gerrit/Setup_SOP/2.%20Configure%20Gerrit%20on%20Website/Configure_Gerrit_on_Website/","content":"\nThis topic is used to record how to configure Gerrit on Website.You must have successfully completed the first chapter before you can execute this chapter.\n\n1. Login administrator account \n2. Create a user group for test   \n3. Create a Repository for test  \n","categories":["Gerrit"],"tags":["Gerrit"]},{"title":"[Jenkins] 2. Configure Jenkins on Website","url":"/2025/08/22/Jenkins/Setup_SOP/2.%20Configure%20Jenkins%20on%20Website/Configure_Jenkins_on_Website/","content":"\nThis topic is used to record how to configure Jenkins on Website.You must have successfully completed the first chapter before you can execute this chapter.\n\n1. Environment\nOS: Ubuntu 22.04.4 LTS\nGerrit: 3.12.2\nJenkins: 2.516.2\nJdk: 21.0.8\nLocal ip address: 192.168.77.199\n\n2. Create the Jenkins user for gerrit2.1 Swtich the path of terminal to Gerrit_Workplace&#x2F;users&#x2F;cd Gerrit_Workplace/users/\n\n2.2 Create an jenkins account for gerrithtpasswd -m gerrit.password jenkinsNew password: Re-type new password: Adding password for user jenkins\n\n2.3 Set jenkins account as an Service Users\nLogin with administrator account\n\n2.4 Generate ssh key on the server which is login jenkinsssh-keygen -t rsa -b 4096 -C &quot;jenkins_dev@dev.com&quot;\n\n2.5 Copy the content of id_rsa.pub to gerritcd ~/.sshubuntu@ubuntu-VirtualBox:~/.ssh$ ls -ltotal 20-rw------- 1 ubuntu ubuntu 3381  8月 22 17:17 id_rsa-rw-r--r-- 1 ubuntu ubuntu  745  8月 22 17:17 id_rsa.pub\n\n\nLogin with jenkins account, and copy id_rsa.pub to New SSH key\n\n3. Make sure that plugin Gerrit Trigger is installed\nLogin admin account\nCheck Gerrit Trigger is exist under installed plugins page, if everything is ok, you will see this like below:\nif it is not exist, go to Available plugins page, search Gerrit Trigger then install it\n\n4. Setting Gerrit Trigger4.1 Select Gerrit Trigger on the bottom  \n4.2 Select New Server  \n4.3 Setting Gerrit Connection Setting  \n4.4 Configure the necessary item   \n4.5 Setting REST API\nGenerate New Password under HTTP Credentials bar in gerrit setting page, you should login witch user: jenkins\nInput your gerrit user: jenkins to under Use REST API bar\nCopy New Password to Gerrit HTTP Password under Use REST API bar\nClick Test REST Connection, if everything is ok, the test will pass\n\n4.6 If everything is ok, Gerrit Servers status will be a green pass logo  \n","categories":["Jenkins"],"tags":["Jenkins"]}]